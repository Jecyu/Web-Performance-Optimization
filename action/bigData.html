<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>大数据量的渲染优化 | 微谈 Web 前端性能优化</title>
    <meta name="description" content="Analysis vue.js deeply">
    <link rel="icon" href="/Web-Performance-Optimization/logo.png">
  <link rel="manifest" href="/Web-Performance-Optimization/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/Web-Performance-Optimization/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/Web-Performance-Optimization/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css" as="style"><link rel="preload" href="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/2.72369abb.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/17.f2b51082.js" as="script"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/10.a5dacc7d.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/11.02148d24.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/12.acd7b156.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/13.837abe37.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/14.0f6e7494.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/15.b7cfaf21.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/16.18e998c2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/18.fd8bf8b2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/19.ac77f635.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/20.f3fb8221.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/21.b6c75ca9.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/22.5b60da5a.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/23.e8cdc260.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/24.18b6675d.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/25.81f7219b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/26.cf52eab7.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/27.892d8e46.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/28.36470c5c.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/29.94a5d762.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/3.c2cb7e60.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/30.01fe9788.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/31.21d6cc04.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/32.b9a9aea8.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/33.d303235b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/34.0696d0a6.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/35.523a3368.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/36.3ec948c0.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/4.df7b7976.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/5.d4962001.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/6.66c2d2c9.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/7.ffbcbdd2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/8.7a41af06.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/9.a97348ef.js">
    <link rel="stylesheet" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Web-Performance-Optimization/" class="home-link router-link-active"><!----> <span class="site-name">微谈 Web 前端性能优化</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/concept/" class="sidebar-link">Web 性能优化基础认知</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/tool-monitor/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/indicator.html" class="sidebar-link">解读 Web 性能体验和质量指标</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/chromeDev.html" class="sidebar-link">唯快不破，Chrome DevTools 性能优化手把手教学</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/network/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/network/request.html" class="sidebar-link">资源请求</a></li><li><a href="/Web-Performance-Optimization/network/download.html" class="sidebar-link">资源下载</a></li><li><a href="/Web-Performance-Optimization/network/render.html" class="sidebar-link">资源渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>缓存篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/cache/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/cache/browser-cache.html" class="sidebar-link">浏览器之 HTTP 缓存机制解读</a></li><li><a href="/Web-Performance-Optimization/cache/browser-localStorage.html" class="sidebar-link">浏览器之本地存储——Cookie、Web Storage、IndexedDB</a></li><li><a href="/Web-Performance-Optimization/cache/webapp.html" class="sidebar-link">Web 运行时缓存</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>渲染篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/browser/" class="sidebar-link">浏览器背后的运行机制</a></li><li><a href="/Web-Performance-Optimization/browser/render.html" class="sidebar-link">浏览器渲染过程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>应用篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/action/bigData.html" class="active sidebar-link">大数据量的渲染优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#分页" class="sidebar-link">分页</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#长列表" class="sidebar-link">长列表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#懒渲染" class="sidebar-link">懒渲染</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#可视区域渲染（虚拟列表）" class="sidebar-link">可视区域渲染（虚拟列表）</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#虚拟列表优化版" class="sidebar-link">虚拟列表优化版</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#树的优化" class="sidebar-link">树的优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#在可视区域的情况下，如何同时支持搜索" class="sidebar-link">在可视区域的情况下，如何同时支持搜索</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#虚拟-dom-方案优化" class="sidebar-link">虚拟 DOM 方案优化</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#vue-树组件" class="sidebar-link">vue 树组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#原因分析" class="sidebar-link">原因分析</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#改写-iview-树组件" class="sidebar-link">改写 iview 树组件</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/action/bigData.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/Web-Performance-Optimization/action/code.html" class="sidebar-link">代码层面的优化</a></li><li><a href="/Web-Performance-Optimization/action/chart.html" class="sidebar-link">图表的性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>参考资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/reference/" class="sidebar-link">Web 性能优化资源合集（持续更新）</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="大数据量的渲染优化"><a href="#大数据量的渲染优化" class="header-anchor">#</a> 大数据量的渲染优化</h1> <p>来自问题：<a href="https://www.wwwbuild.net/beautifulFront/5507.html" target="_blank" rel="noopener noreferrer">当后端一次性丢给你10万条数据 作为前端工程师的你要怎么处理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>基本策略：</p> <ul><li>延迟（执行、加载）</li> <li>按需（加载）</li> <li>缓存（资源）</li> <li>预备（提前执行、加载）</li></ul> <h2 id="分页"><a href="#分页" class="header-anchor">#</a> 分页</h2> <ul><li>实例</li> <li>使用超图/Arcgis 服务，前端进行请求分页</li> <li>在做一张图的条件组合查询功能中，将查询出来的结果放入表格中，由于当数据集的结果很多的时候，请求就特别耗时，表格就要 loading 很久才出来。后面可以使用懒加载进行优化，不要一次性把全部数据请求回来。
由于 maxFeatures 默认是 1000，所以请求默认最多只会 1000 条数据，但有些数据集可能会超过 1000 条数据。
目前的解决方法是，当 totalCount 大于 1000 时，把 totalCount 扔 maxFeatures 再次请求。但这样的问题是，加载速度特别慢。</li></ul> <p>分页的情况下，再 + 上懒加载？</p> <p>支实施系统-合规审查</p> <h2 id="长列表"><a href="#长列表" class="header-anchor">#</a> 长列表</h2> <p>无法使用分页的情况下，采用长列表，例如移动端的滚动方案。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>长列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>长列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>createElement<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./demo01.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description: 创建带文本元素
 * @param {type}
 * @return:
 */</span>

<span class="token keyword">var</span> <span class="token function-variable function">createElements</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

document
  <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#btn&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token function">createElements</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="懒渲染"><a href="#懒渲染" class="header-anchor">#</a> 懒渲染</h3> <p>在滚动到页面底部的时候，再去加载剩余的数据。这是一种前后端共同优化的方式，跟分页很像。</p> <p>实现思路：监听父元素的 <code>scroll</code> 事件（一般是 window），通过父元素的 scrollTop 判断是否到了页面底部，如果到了页面底部，就加载更多的数据。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>懒渲染<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">.lazy-render-list</span> <span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #666<span class="token punctuation">;</span>
        <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token selector">.lazy-render-list-item</span> <span class="token punctuation">{</span>
        <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
        <span class="token property">line-height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
        <span class="token property">padding-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
        <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #666<span class="token punctuation">;</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>lazy-render-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./demo03.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description: 解决底部一定距离，如提前加载数据
 * @param {type}
 * @return:
 */</span>
<span class="token keyword">let</span> <span class="token function-variable function">isCloseToBottom</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> distance</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> maxScrollTop <span class="token operator">=</span> el<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> el<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
  <span class="token keyword">const</span> currentScrollTop <span class="token operator">=</span> el<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> distance<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>maxScrollTop <span class="token operator">&lt;=</span> currentScrollTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">createElements</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> count<span class="token punctuation">,</span> delta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> count<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count <span class="token operator">+</span> delta<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> templateString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div class=&quot;lazy-render-list-item&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> templateString<span class="token punctuation">;</span>
    <span class="token keyword">const</span> liDom <span class="token operator">=</span> div<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> tempCount <span class="token operator">=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">let</span> delta <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span> <span class="token comment">// 增量，一次加载 40 条</span>
  <span class="token function">createElements</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> tempCount<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
  count <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">updated</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target <span class="token operator">||</span> e<span class="token punctuation">.</span>srcElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCloseToBottom</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token function">loadData</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> outerDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.lazy-render-list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadData</span><span class="token punctuation">(</span>outerDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  outerDom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;scroll&quot;</span><span class="token punctuation">,</span> updated<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="可视区域渲染（虚拟列表）"><a href="#可视区域渲染（虚拟列表）" class="header-anchor">#</a> 可视区域渲染（虚拟列表）</h3> <p>通过懒渲染可以解决初始渲染的性能问题，但是在不断加载过后，整个列表会变得非常长，每次滚动都要改变所有的节点的位置，引发<code>回流</code>导致<code>重绘</code>，导致响应缓慢，并且过多的节点对象占用了大量的堆、栈内存。</p> <p><a href="placeholder">通过 performance 获得的 10000 个节点每次滚动的时间花费</a></p> <p>因此，为了解决这个问题，我们需要可视区域渲染（业界内通常称为<code>虚拟列表</code>）。</p> <p><code>可视区域</code>指的是只渲染可视区域的列表项，非可见区域的完全不渲染，在滚动条滚动时动态更新列表项（跟<code>断点续传</code>的套路很像，进行分片切割，网络缓冲区）。可视区域渲染适合下面这种场景：</p> <ol><li><p>每个数据的展现形式的高度需要一致（<code>非必须</code>）。</p></li> <li><p>产品设计上，一次需要加载的数据量比较大「1000 条以上」。</p></li> <li><p>产品设计上，滚动条需要挂载在一个固定高度的区域（在 window 上也可以，但是需要整个区域都只显示这个列表）。</p></li></ol> <p>虚拟列表指的就是【可视区域渲染】的列表，重要的基本就是两个概念：</p> <ul><li><code>可滚动区域</code>：假设有 1000 条数据，每个列表项的高度是 30，那么可滚动的区域的高度就是 1000*30。当用户改变列表的滚动条的当前滚动值的时候，会造成可见区域的内容的变更。</li> <li><code>可见区域</code>：比如列表的高度是 300，右侧纵向滚动条可以滚动，那么视觉可见的区域就是可见区域。</li></ul> <p>思路：</p> <ol><li>计算当前可见区域起始数据的 <code>startIndex</code></li> <li>计算当前可见区域结束数据的 <code>endIndex</code></li> <li>计算当前<code>可见区域的数据</code>，并渲染到页面中</li> <li>计算 startIndex 对应的数据在整个列表中的偏移位置 <code>startOffset</code>，并设置到列表上。
<img src="/Web-Performance-Optimization/assets/img/2020-06-05-15-01-00-virtual-list.ef8c88c5.png" alt=""></li></ol> <p>思路详解：</p> <ul><li>HTML 结构上使用 phantom 作为幽灵元素，占位高度 contentHeight（由所有列表项的高度总和），使得容器可以滚动。</li> <li>根据可视区域的高度以及每条数据的固定高度，计算出可以显示的条数 visibleCount，对整个的数据 data 切割出初始化显示的数据 visibleData。</li> <li>然后触发滚动事件，根据 <code>this.start = Math.floor(scrollTop / this.itemHeight)</code> 计算出起点位置，以及 start + visibleCount 计算终点位置，切割出当前要显示的数据。</li> <li>由于滚动了列表内容元素，因此需要使用 transform 把列表容器移回可视区域，移动 Y 为<code>fixedScrollTop = scrollTop - scrollTop % this.itemHeight;</code></li></ul> <ol><li>HTML 结构</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-view<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-view-phantom<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-view-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- &lt;div class=&quot;list-view-item&quot;&gt;&lt;/div&gt; --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>CSS</li></ol> <ul><li>列表元素 <code>.list-view</code> 使用相对定位</li> <li>使用一个不可见元素 <code>.list-view-phantom</code>撑起这个列表，让列表的滚动条出现</li> <li>列表的可见元素 <code>.list-view-content</code> 使用绝对定位，left、right、top 设置为 0</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.list-view</span> <span class="token punctuation">{</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #666<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.list-view-phantom</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> -1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.list-view-content</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.list-view-item</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token property">padding-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
  <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
  <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #666<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>JS</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target <span class="token operator">||</span> e<span class="token punctuation">.</span>srcElement<span class="token punctuation">;</span>
    <span class="token keyword">const</span> scrollTop <span class="token operator">=</span> target<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
    <span class="token comment">// 减去整除 itemHeigt 多出来的距离，得到整倍数，并进行 transformY 移动，使listViewContentDom容器的位置回到可见区域（因为滚动导致）</span>
    <span class="token keyword">const</span> fixedScrollTop <span class="token operator">=</span> scrollTop <span class="token operator">-</span> scrollTop <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">;</span> <span class="token comment">// 跟下面的 start 求值做对应处理，因此只需要移动整倍数。</span>
    <span class="token comment">// const fixedScrollTop = scrollTop; // 直接采用这个的话，拖到底部后会出现页面抖动现象。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listViewContentDom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(0, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fixedScrollTop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">// 改变要渲染的数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>scrollTop <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 起点数据不会计算上余数，因此不会多请求额外的数据，保证整个容器高度容纳了所有显示的数据。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>visibleData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVisibleData</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderListViewContentDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
   * @description: 获得渲染的数据
   * @param {type}
   * @return:
   */</span>
  <span class="token function">getVisibleData</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> start <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>visibleCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>clientHeight <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向上取整</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>visibleCount<span class="token punctuation">;</span>
    <span class="token keyword">const</span> visibleData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> visibleData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mockData</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listViewDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.list-view&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> phantomDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.list-view-phantom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 幽灵元素，用于占位高度，使容器可以一直滚动</span>
    phantomDom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listViewContentDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.list-view-content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>visibleData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVisibleData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listViewDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderListViewContentDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listViewDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>优化结果</p> <ul><li>大大减少渲染的节点，渲染和 DOM 回收，不会渲染全部数据。</li> <li>如果把每个 listItem 抽离为一个组件的，也能大大减少实例化的组件。</li> <li>需要考虑滚动导致的性能问题
</li></ul> <p>更进一步封装，可以把 ListView 抽离为一个适配器组件，把需要渲染的组件丢进去即可实现可视区域渲染。</p> <ul><li>可参考 https://github.com/Saberteeth/ListView/blob/master/src/index.js</li> <li>以及 react-component/list-view</li></ul> <h4 id="可视区域渲染-懒渲染"><a href="#可视区域渲染-懒渲染" class="header-anchor">#</a> 可视区域渲染 + 懒渲染</h4> <p>只需要把在 handleScroll 添加滚动至底部的时候，进行数据的增加，并重新渲染即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target <span class="token operator">||</span> e<span class="token punctuation">.</span>srcElement<span class="token punctuation">;</span>
    <span class="token comment">// 加载更多的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isCloseToBottom</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>this<span class="token punctuation">.</span><span class="token function">mockData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;loadmore =&gt;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>scrollTop <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改变起始位置</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// .....</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="虚拟列表优化版"><a href="#虚拟列表优化版" class="header-anchor">#</a> 虚拟列表优化版</h3> <ul><li>去掉高度限制</li> <li>缓存计算结果</li> <li>优化搜索性能</li></ul> <h4 id="去掉高度限制"><a href="#去掉高度限制" class="header-anchor">#</a> 去掉高度限制</h4> <p>实际上是通过动态传递高度来实现，这样就不需要提前通过 css 高度设置好了，但是不代表可以自动计算高度而不传递。</p> <div class="language-js extra-class"><pre class="language-js"><code>props<span class="token punctuation">:</span> itemSizeGetter<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> Function<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">itemSizeGetter</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最小高度为 30，这里增加高度看每个列表项的设置 { value: 330 vlaue:}，新增 0～9，实际上可以随意设置规则。</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div> <h2 id="树的优化"><a href="#树的优化" class="header-anchor">#</a> 树的优化</h2> <p>性能原因：节点过多导致内存问题，其他是需要计算样式过多 padding-left。</p> <ul><li>初始展开的节点少，向 dom 中插入节点就会少，速度更快。</li> <li>treeNodes 总数据量尽量少变化，缓存并复用计算出的 treeNodes</li></ul> <p>分两步：</p> <ol><li>将 tree 数据和 DOM 结构的扁平化</li> <li>然后采用虚拟列表方案</li> <li>需要处理好隐藏的节点的问题，也就是展开、收缩导致的节点差距，这是跟列表的另一区别，同步好展开、收缩的张图。</li></ol> <p>虚拟长列表控制 DOM 渲染数量。</p> <h3 id="在可视区域的情况下，如何同时支持搜索"><a href="#在可视区域的情况下，如何同时支持搜索" class="header-anchor">#</a> 在可视区域的情况下，如何同时支持搜索</h3> <p>把搜索的数据，支持赋予给 this.data 即可，然后 this.visibleData 根据滚动来对 this.data 进行截取。</p> <p>对于 chrome 的 ctrl + F 搜索的，可以对这个操作进行劫持，参考 GitHub 的编辑功能，这样就不会限制于已经渲染的内容了。</p> <h2 id="虚拟-dom-方案优化"><a href="#虚拟-dom-方案优化" class="header-anchor">#</a> 虚拟 DOM 方案优化</h2> <h2 id="vue-树组件"><a href="#vue-树组件" class="header-anchor">#</a> vue 树组件</h2> <p>除了虚拟化组件外，只能说改变递归等性能了。
跟普通使用 JS 实现的树，vue 树组件主要多了响应式的监听性能，也就是<code>收集依赖</code>和<code>派发更新</code>。</p> <p>响应式的设计，更适合对节点进行增删改查的操作，所以才有 vue 树的需求，不仅仅是原生的树节点。但是当整个列表节点非常多的时候，就不建议移动了，但是修改还是有必要的。</p> <p>tree 的性能缓慢原因，树以及它为什么能够解决初始大数据渲染的原因（重绘），然后应用到自己写的 tree 中。</p> <p>关于这个性能问题，是因为那边有个目录树有 2000+子节点，用 iview 自带的 tree 组件加载非常卡顿，根本无法使用。iview 的 tree 组件我之前优化过源码，但是 2000+的子节点一样会存在性能问题，这和 vue 和作者设计有关，引起卡顿原因：</p> <p>1、折叠节点一次就要重新递归一次
2、数据改变，vue 就要触发收集依赖相关函数，和 computed 的回调函数，1 个子节点 1 个函数，1 个函数耗时 6ms，1000*6ms = 6000ms === 6s，所以加载很慢</p> <h3 id="原因分析"><a href="#原因分析" class="header-anchor">#</a> 原因分析</h3> <h3 id="改写-iview-树组件"><a href="#改写-iview-树组件" class="header-anchor">#</a> 改写 iview 树组件</h3> <p>一些疑问：</p> <ol><li>异步加载树节点，没必要一口气全都递归渲染出来</li> <li>用一个 list 把 id 和 value 对应起来，没问题。但是用一个 key 来的数值来表示 tree 的层级，并且 dom 显示的时候都以这个 key 来作为依据，这样的代码以后谁看的懂。tree 结构本身是有它的好处的。</li> <li>最后，如果真的存在单个节点下有几万条数据，那应该是想着改变交互，提供搜索，而不是渲染出来。</li></ol> <p>回答：</p> <ol><li>异步加载树节点很多场景不适用，比如需要搜索某个节点。</li> <li>vue 节点创建过多，vue 创建实例花费时间。</li> <li>我们都知道代码是给人看的递归写法当然简单明了，但是当递归写法已经限制了我们的需求我们也应当寻找新的模式来实现。</li> <li>最后更改交互方式是业务产品以及用户体验需要考虑的，作为开发人员能做的是通过需求提高技术能力以有所成长，当然产品如果能够接受更改交互，技术人员好办得多，<u>只是我们不应该逃避问题，而应该直面问题并解决问题，这样我们才会有所提升。</u></li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>对大数据渲染可以采用延迟和按需加载的方案，具体实现的例子就是向下滚动加载更多和可视区渲染。</p> <p>而可视区渲染方案采用了大量的数据进行测试，并且在实际中加载 上万甚至十万条数据事实上是不常规可拒绝的，但是如果你一条复杂 item 里面有 10 个 div 呢？结果就是 2000 条就会出现性能问题，如果有复杂图片呢？再加上部分富文本展示呢？也许几十条数据就发生了性能问题。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Jecyu/Web-Performance-Optimization/edit/master/docs/action/bigData.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/17/2020, 6:12:19 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Web-Performance-Optimization/browser/render.html" class="prev">浏览器渲染过程</a></span> <span class="next"><a href="/Web-Performance-Optimization/action/code.html">代码层面的优化</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" defer></script><script src="/Web-Performance-Optimization/assets/js/2.72369abb.js" defer></script><script src="/Web-Performance-Optimization/assets/js/17.f2b51082.js" defer></script>
  </body>
</html>
