<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器之本地存储——Cookie、Web Storage、IndexedDB | 微谈 Web 前端性能优化</title>
    <meta name="description" content="Analysis vue.js deeply">
    <link rel="icon" href="/Web-Performance-Optimization/logo.png">
  <link rel="manifest" href="/Web-Performance-Optimization/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/Web-Performance-Optimization/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/Web-Performance-Optimization/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css" as="style"><link rel="preload" href="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/2.72369abb.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/10.a5dacc7d.js" as="script"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/11.02148d24.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/12.acd7b156.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/13.837abe37.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/14.0f6e7494.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/15.b7cfaf21.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/16.18e998c2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/17.f2b51082.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/18.fd8bf8b2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/19.ac77f635.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/20.f3fb8221.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/21.b6c75ca9.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/22.5b60da5a.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/23.e8cdc260.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/24.18b6675d.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/25.81f7219b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/26.cf52eab7.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/27.892d8e46.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/28.36470c5c.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/29.94a5d762.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/3.c2cb7e60.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/30.01fe9788.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/31.21d6cc04.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/32.b9a9aea8.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/33.d303235b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/34.0696d0a6.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/35.523a3368.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/36.3ec948c0.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/4.df7b7976.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/5.d4962001.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/6.66c2d2c9.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/7.ffbcbdd2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/8.7a41af06.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/9.a97348ef.js">
    <link rel="stylesheet" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Web-Performance-Optimization/" class="home-link router-link-active"><!----> <span class="site-name">微谈 Web 前端性能优化</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/concept/" class="sidebar-link">Web 性能优化基础认知</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/tool-monitor/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/indicator.html" class="sidebar-link">解读 Web 性能体验和质量指标</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/chromeDev.html" class="sidebar-link">唯快不破，Chrome DevTools 性能优化手把手教学</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/network/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/network/request.html" class="sidebar-link">资源请求</a></li><li><a href="/Web-Performance-Optimization/network/download.html" class="sidebar-link">资源下载</a></li><li><a href="/Web-Performance-Optimization/network/render.html" class="sidebar-link">资源渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>缓存篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/cache/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/cache/browser-cache.html" class="sidebar-link">浏览器之 HTTP 缓存机制解读</a></li><li><a href="/Web-Performance-Optimization/cache/browser-localStorage.html" class="active sidebar-link">浏览器之本地存储——Cookie、Web Storage、IndexedDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#网页存储概览" class="sidebar-link">网页存储概览</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#网站哪些地方可以使用本地存储技术提升体验-性能的" class="sidebar-link">网站哪些地方可以使用本地存储技术提升体验/性能的</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#存储分类" class="sidebar-link">存储分类</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#一张图表格对比" class="sidebar-link">一张图表格对比</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#cookie" class="sidebar-link">Cookie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#如何工作" class="sidebar-link">如何工作</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#cookie-可以用在-web-应用哪里提升性能" class="sidebar-link">Cookie 可以用在 Web 应用哪里提升性能</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#如何解决-cookie-带来的性能问题" class="sidebar-link">如何解决 Cookie 带来的性能问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#web-storage" class="sidebar-link">Web Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#特性" class="sidebar-link">特性</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#如何工作-2" class="sidebar-link">如何工作</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#web-storage-的应用场景" class="sidebar-link">Web Storage 的应用场景</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#如何提升-web-storage-的读取性能" class="sidebar-link">如何提升 Web Storage 的读取性能</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#cache-api" class="sidebar-link">Cache API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#如何使用" class="sidebar-link">如何使用</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#cache-的应用场景" class="sidebar-link">Cache 的应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#indexdb" class="sidebar-link">IndexDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#indexdb-的基本使用流程" class="sidebar-link">IndexDB 的基本使用流程</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#indexeddb-的应用场景" class="sidebar-link">IndexedDB 的应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/cache/browser-localStorage.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/Web-Performance-Optimization/cache/webapp.html" class="sidebar-link">Web 运行时缓存</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>渲染篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/browser/" class="sidebar-link">浏览器背后的运行机制</a></li><li><a href="/Web-Performance-Optimization/browser/render.html" class="sidebar-link">浏览器渲染过程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>应用篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/action/bigData.html" class="sidebar-link">大数据量的渲染优化</a></li><li><a href="/Web-Performance-Optimization/action/code.html" class="sidebar-link">代码层面的优化</a></li><li><a href="/Web-Performance-Optimization/action/chart.html" class="sidebar-link">图表的性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>参考资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/reference/" class="sidebar-link">Web 性能优化资源合集（持续更新）</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器之本地存储——cookie、web-storage、indexeddb"><a href="#浏览器之本地存储——cookie、web-storage、indexeddb" class="header-anchor">#</a> 浏览器之本地存储——Cookie、Web Storage、IndexedDB</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>除了浏览器的 HTTP 缓存外，利用浏览器的本地存储技术（比如 LocalStorage、IndexDB）也能大大提升 web 应用的性能。通过把数据存储在浏览器中，用户不必每次都想向服务器请求获取同一个资源。在你离线时，使用本地存储的数据而不是向远端服务器上请求数据就显得非常有用，甚至在线用户也可以从中获得较好的体验。</p> <p><strong>目标读者</strong>：对浏览器提供本地存储的技术没有一个全局了解，不知道在 Web 应用哪里使用它们去提升性能，也不清楚如何提升这些 API 的读取性能。</p> <p><strong>文章大纲</strong>：先全局了解存储分类，然后再具体介绍如何使用以及怎样利用它们提升 web 应用的性能。</p> <ul><li>网页存储概览</li> <li>Cookie</li> <li>Web Storage
<ul><li>LocalStorage</li> <li>SessionStorage</li></ul></li> <li>CacheAPI</li> <li>IndexDB</li></ul> <p><strong>阅读时长</strong>：20 min</p> <p><strong>浏览器版本</strong>：Google Chrome 版本 85.0.4183.121（正式版本）（64 位），使用“隐身模式”不会再计算机上留下您访问网站的任何痕迹，包括缓存文件、Cookie、历史记录、下载记录等等，以及不受插件的影响。对于保存的缓存而言，意味着退出隐身模式即自动清除所有缓存。</p> <h2 id="网页存储概览"><a href="#网页存储概览" class="header-anchor">#</a> 网页存储概览</h2> <p>打开浏览器 Chrome 调试工具，进入 Application 面板，可以看到红色框则为浏览器本地存储技术模块。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-22-01-00-39.c2e89d3a.png" alt=""></p> <blockquote><p>Application Cache API 和 WebSQL 均已废弃。</p></blockquote> <p>对于以上的存储模块，可以通过数据模型、持久化、浏览器支持、事务处理、同步/异步等指标进行分类。</p> <h3 id="网站哪些地方可以使用本地存储技术提升体验-性能的"><a href="#网站哪些地方可以使用本地存储技术提升体验-性能的" class="header-anchor">#</a> 网站哪些地方可以使用本地存储技术提升体验/性能的</h3> <ul><li>只保存重要页面的重要数据（提升性能）
<ul><li>典型的，首页首屏</li> <li>对业务庞大的站点，这点尤其重要</li></ul></li> <li>极大提高用户体验的数据
<ul><li>比如表单的状态，可以提交之前保存，当用户刷新页面时可以还原</li> <li>静态资源，比如 js 和 css</li></ul></li> <li>pwa 离线应用</li></ul> <p>那么我应该使用哪些存储技术，如何优化上述的方面呢？</p> <h3 id="存储分类"><a href="#存储分类" class="header-anchor">#</a> 存储分类</h3> <h4 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h4> <p>用于存储数据单元的模型可确定在<strong>内部组织数据的方式</strong>，这会影响存储的易用性、成本和性能以及检索请求。</p> <ul><li><strong>结构化</strong>：在具有预定义字段的表格中存储数据，与典型的基于 SQL 的数据库管理系统一样，非常适用于灵活的动态查询。</li> <li><strong>键/值</strong>：键/值数据储存储区和相关的 NoSQL 数据库让你可以存储和检索唯一键值索引的非结构化的数据。</li> <li><strong>字节流</strong>：这个简单模型以可变长度、不透明的字节字符串形式存储数据，将任意形式的内部组织置于应用层。此模型特别适合文件系统和其他按层次结构组织的数据块。</li></ul> <h4 id="持久化（persistence）"><a href="#持久化（persistence）" class="header-anchor">#</a> 持久化（Persistence）</h4> <p>网络应用的存储方法，可根据使数据持久化的作用域进行分析：</p> <ul><li><strong>会话持久化（Session Persistence）</strong>：仅在一个网页会话或浏览器标签处于活动状态时保留此类别的数据。</li> <li><strong>设备持久化（Device Persistence）</strong>：在特定设备中中跨会话和浏览器标签/窗口保留此类别中的数据。</li> <li><strong>全局持久化 （Global Persistence）</strong>：跨会话和设备保留此类别中的数据，它是最可靠的数据持久形式，比如 Google 的云端存储。</li></ul> <h4 id="浏览器支持"><a href="#浏览器支持" class="header-anchor">#</a> 浏览器支持</h4> <p>基于项目开发问题选择最合适的 API，并且要考虑到 API 的规范标准化，也就是该 API 的使用寿命、支持是否广泛，生态系统比如第三方库是否丰富。</p> <h4 id="事务处理"><a href="#事务处理" class="header-anchor">#</a> 事务处理</h4> <p>所谓的事务就是一系列的操作必须全部执行，而不能仅执行一部分。例如一个转账工作。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 从 id=1 的账户给 id=2 的账户转账 100 元</span>
<span class="token comment">-- 第一步：将 id = 1 的 A 账户余额减去 100</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">100</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 第二步：将 id=2 的 B 账户余额加上 100</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">100</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>通常，它对于是否能以原子方式成功手机相关存储操作非常重要。</p> <h4 id="同步-异步"><a href="#同步-异步" class="header-anchor">#</a> 同步/异步</h4> <p>由于存储或检索请求会阻止当前活动的线程（网页主线程）直到请求已完成，因此，某些存储 API 是同步的。这在网页浏览器中是特别沉重的负担，其中存储请求会与 UI 共享主线程。出于效率和性能的考虑，将异步存储 API 作为首选。</p> <h3 id="一张图表格对比"><a href="#一张图表格对比" class="header-anchor">#</a> 一张图表格对比</h3> <table><thead><tr><th>API</th> <th>数据模型</th> <th>持久化</th> <th>浏览器支持</th> <th>事务处理</th> <th>同步/异步</th></tr></thead> <tbody><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/FileSystem" target="_blank" rel="noopener noreferrer">File system<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>字节流</td> <td>设备</td> <td><a href="https://cloud.google.com/storage/?hl=zh-cn" target="_blank" rel="noopener noreferrer">52%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>不支持</td> <td>异步</td></tr> <tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer">Local Storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>键/值</td> <td>设备</td> <td><a href="https://caniuse.com/namevalue-storage" target="_blank" rel="noopener noreferrer">93%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>不支持</td> <td>同步</td></tr> <tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer">Session Storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>键/值</td> <td>会话</td> <td><a href="https://caniuse.com/namevalue-storage" target="_blank" rel="noopener noreferrer">93%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>不支持</td> <td>同步</td></tr> <tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" target="_blank" rel="noopener noreferrer">Cookie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>结构化</td> <td>设备</td> <td>100%</td> <td>不支持</td> <td>同步</td></tr> <tr><td><a href="https://www.w3.org/TR/webdatabase/" target="_blank" rel="noopener noreferrer">WebSQL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>结构化</td> <td>设备</td> <td><a href="http://caniuse.com/#feat=sql-storage" target="_blank" rel="noopener noreferrer">77%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>支持</td> <td>异步</td></tr> <tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage" target="_blank" rel="noopener noreferrer">Cache<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>键/值</td> <td>设备</td> <td><a href="http://caniuse.com/#feat=serviceworkers" target="_blank" rel="noopener noreferrer">60%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>不支持</td> <td>异步</td></tr> <tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer">IndexedDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>混合</td> <td>设备</td> <td><a href="http://caniuse.com/#feat=indexeddb" target="_blank" rel="noopener noreferrer">83%<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>支持</td> <td>异步</td></tr> <tr><td><a href="https://cloud.google.com/storage/?hl=zh-cn" target="_blank" rel="noopener noreferrer">cloud storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>字节流</td> <td>全局</td> <td>100%</td> <td>不支持</td> <td>两者皆有</td></tr></tbody></table> <p>最好选择在尽可能多的浏览器上受广泛支持的 API，其可提供异步调用模型，以最大程度提高与 UI 的互操作性。</p> <ul><li>对于设备本地键/值存储：使用 Cache API。</li> <li>对于设备本地结构化存储：使用 IndexDB</li> <li>对于全局字节流存储：使用云端存储服务。</li></ul> <p>实验性功能：</p> <ul><li>File system</li></ul> <p>W3C 舍弃的功能：</p> <ul><li>WebSQL
</li></ul> <ol><li>W3C 舍弃 Web SQL database 草案,而且是在 2010 年年底，规范不支持了，浏览器厂商已经支持的就支持了，没有支持的也不打算支持了，比如 IE 和 Firefox。(https://www.w3.org/TR/webdatabase/)</li> <li>为什么要舍弃？因为 Web SQL database 本质上是一个<code>关系型数据库</code>，后端可能熟悉，但是前端就有很多不熟悉了，虽然 SQL 的简单操作不难，但是也得需要学习。</li> <li>SQL 熟悉后，真实操作中还得把你要存储的东西，比如对象，转成 SQL 语句，也挺麻烦的。</li></ol> <p>如上所述，除去 File System 和 WebSQL，以及云端存储，接下来会详细讲解与前端息息相关的本地存储 API ，Cookie、Web Storage、IndexDB 以及 Cache API。</p> <p><strong>对比例子</strong>：<a href="https://storage-quota.glitch.me/" target="_blank" rel="noopener noreferrer">https://storage-quota.glitch.me/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h2> <p>打开 Chrome 浏览器，我们可以 Application 面板中展开 Cookie 查看。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-06-18-14-21-19-cookie.4759fee9.png" alt=""></p> <p>Cookie 的本职工作并非本地存储，而是“维持状态”，HTTP 协议是一个无状态协议，服务器接收客户端的请求，返回一个响应，故事到此就结束了，服务器并没有记录关于客户端的任何信息。那么下次请求的时候，如何让服务器知道“我是谁”呢？</p> <p>在这样的背景下，Cookie 应运而生。</p> <p>Cookie 说白了就是一个存储在浏览器里的一个小小的文本文件，它附着在 HTTP 请求上，在浏览器和服务器之间“飞来飞去”。它可以携带用户信息，当服务器检查 Cookie 的时候，便可以获取客户端的状态。相当于一种人为的记录 Cookie，解决 HTTP 协议无状态记录的问题。</p> <p>总的来说，Cookie 主要有三个作用：</p> <ul><li>会话管理
<ul><li>登录、购物车等</li></ul></li> <li>用户个性化
<ul><li>用户偏好设置、主题等</li></ul></li> <li>用户跟踪
<ul><li>记录和分析用户行为</li></ul></li></ul> <h3 id="如何工作"><a href="#如何工作" class="header-anchor">#</a> 如何工作</h3> <p>服务器首先通过 <code>Set-Cookie</code> HTTP 响应头告诉客户端存储 Cookie 键值对。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>HTTP/2.0 <span class="token number">200</span> OK
Content-Type: text/html
Set-Cookie: <span class="token assign-left variable">yummy_cookie</span><span class="token operator">=</span>choco
Set-Cookie: <span class="token assign-left variable">tasty_cookie</span><span class="token operator">=</span>strawberry

<span class="token punctuation">[</span>page content<span class="token punctuation">]</span>
</code></pre></div><p>后续每一次当网页发起 http 请求时，浏览器都会先检查是否有相应的 cookie，有则自动添加在 request header 中的 cookie 字段中。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>GET /sample_page.html HTTP/2.0
Host: www.example.org
Cookie: <span class="token assign-left variable">yummy_cookie</span><span class="token operator">=</span>choco<span class="token punctuation">;</span> <span class="token assign-left variable">tasty_cookie</span><span class="token operator">=</span>strawberry
</code></pre></div><p>完整测试例子：<a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples/cache/demo01/app.js" target="_blank" rel="noopener noreferrer">cache/local/cookie/demo01<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>测试步骤：</p> <ol><li>查看 Application 无 cookie</li> <li>初次 login 后，服务端进行 Set-Cookie，302 重定向到首页<div class="language-sh extra-class"><pre class="language-sh"><code>Set-Cookie: <span class="token assign-left variable">name</span><span class="token operator">=</span>Jecyu<span class="token punctuation">;</span><span class="token assign-left variable">Expires</span><span class="token operator">=</span>Thu, <span class="token number">22</span> Oct <span class="token number">2020</span> 03:58:48 GMT<span class="token punctuation">;</span>HttpOnly<span class="token punctuation">;</span><span class="token assign-left variable">Path</span><span class="token operator">=</span>/
</code></pre></div></li> <li>首页发起请求会自动携带 Cookie，供服务端认证。</li></ol> <h4 id="如何进行读写操作-crud"><a href="#如何进行读写操作-crud" class="header-anchor">#</a> 如何进行读写操作 CRUD</h4> <h5 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h5> <p><strong>服务器设置</strong></p> <p>不管你是请求一个资源文件（如 html/js/css/图片），还是发送一个 ajax 请求，服务端都会返回 response。而 response header 中有一项 set-cookie，是服务端专门用来设置 cookie 的。</p> <p>格式：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Set-Cookie 消息头是一个字符串，其格式如下（中括号中的部分是可选的）</span>
Set-Cookie: value<span class="token punctuation">[</span><span class="token punctuation">;</span> <span class="token assign-left variable">expires</span><span class="token operator">=</span>date<span class="token punctuation">]</span>
</code></pre></div><p>示例：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Set-Cookie: <span class="token assign-left variable">name</span><span class="token operator">=</span>Jecyu<span class="token punctuation">;</span><span class="token assign-left variable">Expires</span><span class="token operator">=</span>Thu, <span class="token number">22</span> Oct <span class="token number">2020</span> 04:44:50 GMT<span class="token punctuation">;</span>HttpOnly<span class="token punctuation">;</span><span class="token assign-left variable">Path</span><span class="token operator">=</span>/
Set-Cookie: <span class="token assign-left variable">job</span><span class="token operator">=</span>web development
</code></pre></div><p>【注意】：一个 Set-Cookie 字段只能设置一个 cookie，当你想要设置多个 cookie，需要添加同样多的 Set-Cookie。服务端可以设置 cookie 的所有选项：expires、domain、path、secure、HttpOnly、SameSite。通过 Set-Cookie 指定的这些可选项只会在浏览器端使用，而不会被发送到服务器。</p> <p><strong>客户端设置</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># document.cookie = 'key=value'</span>
document.cookie <span class="token operator">=</span> <span class="token string">'username=Jecyu;'</span>
</code></pre></div><p>【注意】：客户端可以设置 cookie 的下列选项：expires、domain、path、secure（有条件：只在 https 协议的网页中，客户端设置 secure 类型的 cookie 才能成功），但无法设置 HttpOnly 选项。</p> <p><strong>测试例子</strong>：<a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples/cache/demo02/server.js" target="_blank" rel="noopener noreferrer">cache/local/cookie/demo02<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-22-23-39-07.c064a8a5.png" alt=""></p> <h4 id="一张表格属性"><a href="#一张表格属性" class="header-anchor">#</a> 一张表格属性</h4> <table><thead><tr><th>字段值类型</th> <th>字段名称</th> <th>字段描述</th></tr></thead> <tbody><tr><td>string</td> <td>name</td> <td>Cookie 的名称</td></tr> <tr><td>string</td> <td>value</td> <td>Cookie 的值</td></tr> <tr><td>string</td> <td>domain</td> <td>Cookie 的域（例如“ www.google.com”，“ example.com”）.</td></tr> <tr><td>boolean</td> <td>hostOnly</td> <td>如果 Cookie 是 hostOnly 的 Cookie（即请求的主机必须与 Cookie 的域完全匹配），则为 true。</td></tr> <tr><td>string</td> <td>path</td> <td>Cookie 的路径。</td></tr> <tr><td>boolean</td> <td>secure</td> <td>如果 Cookie 被标记为“secure”（即其范围仅限于安全通道，通常为 HTTPS），则为 true。.</td></tr> <tr><td>boolean</td> <td>httpOnly</td> <td>如果该 cookie 被标记为 HttpOnly（即该 cookie 客户端脚本无法访问），则为 true。).</td></tr> <tr><td>SameSiteStatus</td> <td><a href="https://web.dev/same-site-same-origin/" target="_blank" rel="noopener noreferrer">sameSite<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>从 Chrome 51 开始。cookie 的同站点状态（即 cookie 是否与跨站点请求一起发送.</td></tr> <tr><td>double</td> <td>(optional) expirationDate</td> <td>cookie 的失效日期，以自 UNIX 时代以来的秒数为单位。 不提供会话 cookie。</td></tr></tbody></table> <p><strong>【Expire/Max-Age】</strong></p> <p>如果我们想长时间存放一个 cookie。需要在设置这个 cookie 的时候同时给它设置一个过期的时间。如果不设置，cookie 默认是临时存储的，当浏览器关闭进程的时候自动销毁。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>注意：document.cookie <span class="token operator">=</span> <span class="token string">'名称=值;expires='</span> + UTC 格式的日期型字符串<span class="token punctuation">;</span>
</code></pre></div><p>一个设置 cookie 时效性的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
expires<span class="token punctuation">.</span><span class="token function">setMinutes</span><span class="token punctuation">(</span>expires<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we set the cookie that expires in 1 minute</span>
res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  Location<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>
    name
  <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;Expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expires<span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>expires 是 http/1.0 协议中的选项，在新的 http/1.1 协议中 expires 已经由 max-age 选项代替。expires 的值是一个时间点（cookie 失效时刻= expires），而 max-age 的值是一个以秒为单位的时间段（cookie 失效时刻= 创建时刻 + max-age）。</p> <p>另外，max-age 的默认值是 -1 （即有效期为 session）；max-age 有三种可能值：负数、0、正数。</p> <ul><li>负数：有效期 session（即关闭 tab 页面，则过期）</li> <li>0：删除 cookie</li> <li>正数：有效期为创建时刻 + max-age</li></ul> <p><strong>【domain】</strong></p> <p>domain 指定了 cookie 将要被发送到哪个或哪些域中。默认情况下，domain 会被设置为创建该 cookie 的页面所在的域名，所以当给相同域名发送请求时该 cookie 会被发送至服务器。</p> <p><strong>浏览器会把 domain 的值与请求的域名做一个尾部比较（即从字符串的尾部开始比较），并将匹配的 cookie 发送至服务器</strong>。</p> <p><code>客户端设置</code></p> <p>document.cookie = &quot;username=Jecyu;path=/;domain=qq.com&quot;</p> <p>如上：“www.qq.com” 与 “sports.qq.com” 公用一个关联的域名 “qq.com”，我们如果想让 “sports.qq.com” 下的 cookie 被 “www.qq.com” 访问，我们就需要用到 “cookie” 的 domain 属性，并且需要把 path 属性设置为 “/”。</p> <p><strong><code>服务端设置</code></strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code>Set-Cookie: <span class="token assign-left variable">username</span><span class="token operator">=</span>Jecyu<span class="token punctuation">;</span><span class="token assign-left variable">path</span><span class="token operator">=</span>/<span class="token punctuation">;</span><span class="token assign-left variable">domain</span><span class="token operator">=</span>qq.com
</code></pre></div><p>注意：一定是同域之间的访问，不能把 domain 的值设置成非主域的域名。（客户端 JS 脚本 document.cookie 也不能）</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-23-01-18-14.4d2cca35.png" alt=""></p> <p><strong>【path】</strong></p> <p>Cookie 一般都是由于用户访问页面而创建的，可是并不是只有在创建 cookie 的页面才可以访问这个 cookie。</p> <p>因为安全方面的考虑，默认情况下，只有与创建 cookie 的页面在同一个目录或子目录下的网页才可以访问。</p> <p>即 path 属性可以为服务器特定文档指定 cookie，这个属性设置的 url 且带有这个前缀的 url 路径都是有效的。</p> <p><strong><code>客户端设置</code></strong></p> <p>最常用的例子就是让 cookie 在根目录下，这样不管是哪个子页面创建的 cookie，所有的页面都可以访问到了。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>document.cookie <span class="token operator">=</span> <span class="token string">&quot;username=Jecyu;path=/&quot;</span>
</code></pre></div><p><strong><code>服务端设置</code></strong></p> <p><code>Set-Cookie: name=Jecyu;path=/blog</code></p> <p>如上设置：path 选项值会与 /blog，/blogrool 等等相匹配；任何以 /blog 开头的选项都是合法的。需要注意的是，<strong>只有在 domain 选项核实完毕之后才会对 path 属性进行比较</strong>。path 属性的默认值是发送 Set-Cookie 消息头所对应的 URL 中的 path 部分。</p> <p><strong>domain 和 path 总结：</strong></p> <p>domain 是域名，path 是路径，两者加起来就构成了 URL，domain 和 path 一起来限制 cookie 能被哪些 URL 访问。</p> <p>所以 domain 和 path 2 个 选项共同决定了 cookie 何时被浏览器自动添加到请求头部中发送出去（以及能否被客户端脚本获取）。如果没有设置这两个选项，则会使用默认值。 domain 的默认值为设置该 cookie 的网页所在的域名，path 默认值为设置该 cookie 的网页所在的目录。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-26-21-48-42.9efa2222.png" alt=""></p> <p>上图中，名为 SSESSION 的 cookie 只会发送匹配域名并 path 前缀为 /dgp-server-web-nr 的值，其他请求的不会发送。</p> <p><strong>【secure】</strong></p> <p>通常 cookie 的信息都是使用 HTTP 连接传递数据，这种传递方式很容易被查看，所以 cookie 存储的信息容易被窃取。假如 cookie 中传递的内容比较重要，那么就要求使用加密的数据传输。</p> <p>secure 选项用来设置 cookie 只在确保安全的请求中才会发送。当请求是 HTTPS 或者其他安全协议时，包含 secure 选项的 cookie 才能被发送至服务器。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>document.cookie <span class="token operator">=</span> <span class="token string">&quot;username=Jecyu; secure&quot;</span>
</code></pre></div><p>把 cookie 设置为 secure，并不代表保存在本地的 cookie 文件加密，也不代表他人不能看到你机器本地保存的 cookie 信息。机密且敏感的信息不应该在 cookie 中存储或传输，因为 cookie 整个机制原本就不安全。</p> <p><strong>注意</strong>：在 http 协议的网页中是无法设置 secure 类型 cookie 的，无论是使用客户端还是服务端方式。</p> <p><strong>【HttpOnly】</strong></p> <p>这个选项用来设置 cookie 是否能通过 js 去访问。默认情况下，cookie 不会带 httpOnly 选项（即为空），所以默认情况下，客户端是可以通过 js 代码去访问（包括读取、修改、删除等）这个 cookie 的。当 cookie 带有 httpOnly 选项时，客户端则无法通过 js 代码去访问这个 cookie。</p> <p>在客户端不能通过 js 代码去设置一个 httpOnly 类型的 cookie 的
，这种类型的 cookie 只能通过服务端来设置。</p> <h5 id="读取"><a href="#读取" class="header-anchor">#</a> 读取</h5> <p>我们通过 document.cookie 来获取当前网址下的 cookie 的时候，得到的字符串形式的值，它包含了当前网址下所有的 cookie。（为避免跨域脚本 xss）攻击，这个方法只能获取非 httpOnly 类型的 cookie）。它会把所有的 cookie 通过一个分号 + 空格的形式串联恰里，例如<code>username=Jecyu; job=web development;</code></p> <p>cookie 是同步写的, 无论是 iframe, 还是不同的 window 或者 tab, 任何一个页面修改了 cookie, 其它页面就可以通过 document.cookie 拿到, 但是没法监听 cookie 的改变. 需要注意两点: 一是如果指定了 path, 则不同 path 的页面拿不到, 二是如果设置了 httpOnly, 则 js 无法读取。</p> <p><strong>客户端脚本 document.cookie 只能读取当前 tag 下的 设置的 cookie</strong>，除非且 HttpOnly 为 false。</p> <p>如果页面作为 iframe 嵌入到父页面的话，只要 src 的 域 IP 地址一样（不需要考虑端口号）就可以通过 document.cookie 获取。（比如可以用到这个属性来实现最简单的单点登录，通过在父级域设置 Cookie，然后在各个子级域拿到存在父级域中的 Cookie 值。）</p> <p>测试例子：同时打开 demo02 和 demo03，然后改变其中一个 cookie，看看另一个是否会读取。（注意要刷新，因为 cookie 是同步写的，没法进行监听。）。</p> <h5 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h5> <p>要想修改一个 cookie，只需要重新赋值就行，旧的值会被新的值覆盖。但要注意一点，在设置新 cookie 时，<strong>path/domain 这几个选项一定要跟旧 cookie 保存一样</strong>。否则不会修改旧值，而是添加了一个新的 cookie。</p> <h5 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h5> <p>把要删除的 cookie 的过期时间设置成已过去的时间，path/domain 这几个选项一定要通旧 cookie 保存一样。</p> <p>对于浏览器是如果管理 cookie，可以看 <a href="https://developer.chrome.com/extensions/examples/api/cookies/manager.js" target="_blank" rel="noopener noreferrer">chrome 官方代码模拟实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="cookie-可以用在-web-应用哪里提升性能"><a href="#cookie-可以用在-web-应用哪里提升性能" class="header-anchor">#</a> Cookie 可以用在 Web 应用哪里提升性能</h3> <p>前面说了 Cookie 的特性，只有了解它能干嘛、如何用，才能更好了解它在性能提升的方面应用。</p> <h4 id="cookie-不够大"><a href="#cookie-不够大" class="header-anchor">#</a> Cookie 不够大</h4> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-22-23-39-07.c064a8a5.png" alt=""></p> <p>（图：注意 Size 列为 Cookie 的大小，以字节为单位。）</p> <p>Cookie 是有体积上限的，一般来说它最大只能有 4KB。当 Cookie 存储图片超过 4KB 时，它将面临被裁切的命运。这样看来，Cookie 只能用来存取少量的信息。</p> <h4 id="过量的-cookie-会带来巨大的性能浪费"><a href="#过量的-cookie-会带来巨大的性能浪费" class="header-anchor">#</a> 过量的 Cookie 会带来巨大的性能浪费</h4> <p>Cookie 是紧跟域名的。我们通过响应头里的 Set-Cookie 指定要存储的 Cookie 值。默认情况，domain 被设置为设置 Cookie 页面的主机名，我们也可以手动设置 domain 的值：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Set-Cookie: <span class="token assign-left variable">name</span><span class="token operator">=</span>jecyu<span class="token punctuation">;</span> <span class="token assign-left variable">domain</span><span class="token operator">=</span>jecyu.com
</code></pre></div><p>只要在同一个域名下并符合 path 前缀要求下的所有请求，都会携带 Cookie。如果此刻仅仅是请求一张图片或者一个 CSS 文件，我们也要携带一个 Cookie 跑来跑去（关键是 Cookie 里存储的信息我现在并不需要）。Cookie 虽然小，请求却可以很多，随着请求的叠加，这样的不必要的 Cookie 带来的开销是无法想象的。</p> <p>随着前端应用复杂度的提供，Cookie 也渐渐演化为了一个“存储多面手”——它不仅仅被用于维持状态，还被塞入了一些乱七八糟的其他信息。（例如行政区划 regionKey）</p> <h3 id="如何解决-cookie-带来的性能问题"><a href="#如何解决-cookie-带来的性能问题" class="header-anchor">#</a> 如何解决 Cookie 带来的性能问题</h3> <p>浏览器最初使用 Cookie 的目的就是为了解决 HTTP 无状态的问题，因此存储在 cookie 的数据，每次都会被浏览器自动放在 http 请求中，如果这些数据是每个请求都需要发给服务端的数据（比如身份证信息），浏览器的自动处理就大大免去重复添加操作。如果这些数据不是必须的，就会增加了网络开销。</p> <p>因此可以通过以下几个方式减少 Cookie 带来的性能问题：</p> <ul><li>去除不必要的 Cookie，只放置必要的数据（身份认证）。</li> <li>使 Cookie 体积尽量小以减少用户响应的影响。</li> <li>注意在适应级别的域名上设置 Cookie 以便使子域名不受影响。</li> <li>设置合理的过期时间。较早地 Expire 时间和不要过早去清除 Cookie，都会改善用户的响应时间。</li></ul> <h4 id="项目实践"><a href="#项目实践" class="header-anchor">#</a> 项目实践</h4> <p>以南宁为实践：</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-27-14-30-09.a69a35e9.png" alt=""></p> <p>目前项目 cookie 中存储的东西极少，前端主要设置了 region-key 和 dist-token，不算大。如果其他项目有存储较多的东西，一定要考虑是否对性能有了较大的影响。</p> <h2 id="web-storage"><a href="#web-storage" class="header-anchor">#</a> Web Storage</h2> <p>为了弥补 Cookie 的局限性，让“专业的人做专业的事情”，Web Storage 出现了。Web Storage 是 HTML5 专门为浏览器存储而提供的数据存储机制。它又分为 <code>Local Storage</code> 与 <code>Session Storage</code>。</p> <h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h3> <ul><li>存储容量大：Web Storage 根据浏览器的不同，存储容器可以达到 5-10 M 之间。</li> <li>仅位于浏览器端，不与服务器发生通信。这样就不会把不必要的信息传送给服务端。</li> <li><strong>只能存储字符串信息</strong>，意味着对象需要被序列化才能存储。</li></ul> <h4 id="local-storage-与-session-storage-的区别"><a href="#local-storage-与-session-storage-的区别" class="header-anchor">#</a> Local Storage 与 Session Storage 的区别</h4> <p>两者的区别在于<code>生命周期</code>与<code>作用域</code> 的不同。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-11-02-16-20-27.5aeb721e.png" alt=""></p> <ul><li><strong>生命周期</strong>：Local Storage 是持久化的本地存储，存储在其中的数据是永远不会过期的，使其消失的唯一办法是手动删除。</li> <li><strong>作用域</strong>：<u>Local Storage、Session Storage 和 Cookie 都遵循<strong>同源策略</strong>（所谓同源是指：域名、协议、端口相同），但是 cookie 可以忽略端口。</u>但 Session Storage 特别的一点在于，即便是相同域名的两个页面，只要他们不在同一个浏览器标签页内打开，那么他们的 Session Storage 内容便无法共享。<strong>并且它跟 Cookie 不同的是无法让子域名继承父域名的 localstorage 数据</strong>。不过可以结合 iframe 的 <code>postmessage</code> 进行传递处理，详情见<a href="https://zhuanlan.zhihu.com/p/35738376" target="_blank" rel="noopener noreferrer">使用 localstorage 代替 cookie 实现跨域共享数据<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>注意的是，LocalStorage 和 SessionStorage 都是同步的，会阻塞主线程，特别是在读写大量数据的情况下。都不能被 web worker 或 service worker 访问。</p> <h3 id="如何工作-2"><a href="#如何工作-2" class="header-anchor">#</a> 如何工作</h3> <h4 id="local-storage"><a href="#local-storage" class="header-anchor">#</a> Local Storage</h4> <p>Local Storage 在存储方面没有什么特别的限制，理论上 Cookie 无法胜任的、可以用简单的键值对来存取的数据存储任务，都可以交给 Local Storage 来做。</p> <p>举个例子，考虑到 Local Storage 的特点之一是<code>持久</code>，有时我们更倾向于用它来存储一些内容稳定的资源。比如图片内容丰富的电商网站会用它来存储 Base64 格式的图片字符串：</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-06-18-15-24-51-local-storage.44459fa6.png" alt=""></p> <p>完整测试例子：<a href="https://storage-quota.glitch.me/" target="_blank" rel="noopener noreferrer">https://storage-quota.glitch.me/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="session-storage"><a href="#session-storage" class="header-anchor">#</a> Session Storage</h4> <p>Session Storage 更适合用来存储生命周期和它同步的<code>会话级别</code>的信息。这些信息只存在当前会话，当你开启新的会话时，它也需要相应的更新或释放。比如微博的 Session Storage 就主要是存储你本次会话的浏览足迹：</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-06-18-15-30-29-session-storage.9392a5ba.png" alt=""></p> <p>lastUrl 对应的就是你上一次访问的 URL 地址，这个地址是即时的。当你切换 URL 时，它随之更新，当你关闭页面时，留着它也没有什么意义，就释放它。</p> <h4 id="web-storage-核心-api-使用"><a href="#web-storage-核心-api-使用" class="header-anchor">#</a> Web Storage 核心 API 使用</h4> <p>Web Storage 保存的数据内容和 Cookie 一样，是文本内容，以键值对的形式存在。Local Storage 与 Session Storage 在 API 方面无异，这里我们以 localStorage 为例：</p> <ul><li>存储数据：setItem()</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>localStorage.setItem<span class="token punctuation">(</span><span class="token string">'user_name'</span>, <span class="token string">'xiuyan'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>读取数据： getItem()</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>localStorage.getItem<span class="token punctuation">(</span><span class="token string">'user_name'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>删除某一键名对应的数据： removeItem()</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>localStorage.removeItem<span class="token punctuation">(</span><span class="token string">'user_name'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>清空数据记录：clear()</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>localStorage.clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>完整例子</strong>：https://jecyu.github.io/mini-questionnaire-platform/dist/view/index.html</p> <h4 id="storage-事件"><a href="#storage-事件" class="header-anchor">#</a> Storage 事件</h4> <p>请记住，如果你的网页应用使用了客户端存储技术，用户可以随意访问并修改这些存储的数据。因此，有必要监听 Storage 的事件，以便进行友好的提醒用户。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onStorageChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>回调函数接受一个 event 对象作为参数。这个 event 对象的 key 属性，保存发生变化的键名。除了 key 属性，event 对象的属性还有三个：</p> <ul><li>oldValue：更新前的值。如果该键为新增加，则这个属性为 null。</li> <li>newValue：更新后的值。如果该键被删除，则这个属性为 null。</li> <li>url：原始触发 storage 事件的那个网页的网址。</li></ul> <p>项目上的例子，之前是规划分析评价，用户清除了浏览器缓存并重新刷新，出现白屏。因此获取存储时需要确保是否有，没有进行跳转。或者进行事件通知，将会跳转到固定的地方。</p> <h3 id="web-storage-的应用场景"><a href="#web-storage-的应用场景" class="header-anchor">#</a> Web Storage 的应用场景</h3> <p>localStorage 为标准的键值对数据类型，只要以某种编码方式把想要存储的 localStorage 的对象给转化为字符串，就能轻松支持。举些例子：把对象序列化为 json 字符串，就能存储对象了；把图片转化成 DataUrl（base64），就可以存储图片了。</p> <h4 id="表单状态恢复"><a href="#表单状态恢复" class="header-anchor">#</a> 表单状态恢复</h4> <p>比如一些博客网站，在文章编写没有提交时就进行了页面的刷新，这个时候可以恢复已经写好的文字。</p> <p>什么时候会让用户会做刷新或做跳转页面的操作，最常见的就是登录过期以及页面卡顿的时候。（比单纯提醒用户丢失数据的体验要更好）</p> <ul><li>页面加载时只执行 onload 事件。</li> <li>页面关闭时，先 <code>onbeforeunload</code> 事件，再 <code>onunload</code> 事件。</li> <li>页面刷新时先执行 <code>onbeforeunload</code> 事件，然后 <code>onunload</code> 事件，最后 onload 事件。</li></ul> <h5 id="版本一：未封装版本"><a href="#版本一：未封装版本" class="header-anchor">#</a> 版本一：未封装版本</h5> <ul><li>灵活性较强</li> <li>代码侵入程度高</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同步读取</span>
    <span class="token comment">// 监听页面关闭或刷新</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleBeforeunload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleBeforeunload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 跳转页面，离开当前路由</span>
  <span class="token function">beforeRouteLeave</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">handleBeforeunload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * @description:
     * @param {*}
     * @return {*}
     */</span>
    <span class="token function">getFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      <span class="token keyword">const</span> store <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>store <span class="token operator">&amp;&amp;</span> <span class="token function">typeOf</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> expire <span class="token punctuation">}</span> <span class="token operator">=</span> store<span class="token punctuation">;</span>
        <span class="token comment">// 存储是否过期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          localStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> description <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>formData<span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * @description: 保存表单持久化的版本
     * @param {*}
     * @return {*}
     */</span>
    <span class="token function">saveFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> description <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>formData<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        description
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">,</span>
        expire<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5000</span> <span class="token comment">//  5s</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      localStorage<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * @description: 删除持久化的表单
     * @param {*}
     * @return {*}
     */</span>
    <span class="token function">removeFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      localStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 刷新页面、关闭页面</span>
    <span class="token function">handleBeforeUpload</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>formData<span class="token punctuation">.</span>fileName <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>formData<span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">handlePublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>taskForm<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">valid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> description<span class="token punctuation">,</span> file <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>formData<span class="token punctuation">;</span>
        <span class="token keyword">const</span> timeStamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">,</span> timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;parentOpinionCode&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>loadingStatus <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> <span class="token function">putNewOpinion</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$Message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">&quot;发布意见成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>loadingStatus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>taskForm<span class="token punctuation">.</span><span class="token function">resetFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>n<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token comment">// 清除持久化表单</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeFormPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>loadingStatus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;发布意见失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div> <h4 id="用户偏好设置：用户地图范围、地图服务代理、产品数据等"><a href="#用户偏好设置：用户地图范围、地图服务代理、产品数据等" class="header-anchor">#</a> 用户偏好设置：用户地图范围、地图服务代理、产品数据等</h4> <p>点击模型计算成功的产品，从产品列表 NatureResource/#/FZBZ/BaseDateHandle/ProductsView 进入产品详情：</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-11-03-10-49-01.2bade682.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 获得模型计算成功的数据</span>
    <span class="token keyword">async</span> <span class="token function">fetchDataByCode</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> originRes <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>originRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        originRes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getModelComputedData</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> originRes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 防止后面的处理对源数据的修改造成影响</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>originRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dataFunction</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>同样是刷新页面的应用场景，如果用户对存储数据删除时，要获取事件通知，提醒用户必要数据被删除，将跳转到产品页，避免用户刷新时出现空白问题。</p> <h4 id="静态资源存储"><a href="#静态资源存储" class="header-anchor">#</a> 静态资源存储</h4> <p><img src="/Web-Performance-Optimization/assets/img/2020-11-03-11-04-46.3e86b41d.png" alt=""></p> <p>从淘宝首页中可以看到一些 logo 图片静态资源被以 base64 形式被存储起来了。</p> <p><strong>测试例子</strong>：https://storage-quota.glitch.me/</p> <p>运行上面的例子，可以查看你的浏览器支持的 Web Storage 内存有多大。在 Chrome 85 版本中内存上限均为 5 MB。超过 5MB，是否有降级处理，避免错误。对于更大的静态资源，更适合交给 IndexDB，做 pwa 应用。</p> <h3 id="如何提升-web-storage-的读取性能"><a href="#如何提升-web-storage-的读取性能" class="header-anchor">#</a> 如何提升 Web Storage 的读取性能</h3> <p>除了升级浏览器以获得更好的官方优化性能外，也可以换个方面思考，哪些操作会引起性能问题，就避免去做就好。</p> <ul><li>过于依赖 <code>JSON.stringify</code> ，会导致性能问题，value 尽量使用 string。</li> <li>避免频繁 set/get，尽量将数据缓存进内存，然后页面卸载的时候一次写入。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// before</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'input[type=&quot;checkbox&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&quot;:checked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// after</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'input[type=&quot;checkbox&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&quot;:checked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>阻塞 UI，尽量异步操作，避免阻塞 UI。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// before</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// after</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>localStorage 本质上是对字符串的读取，如果存储内容多的话会消耗空间，会导致页面变卡。Web Storage 是否能 hold 住所有的存储场景呢？</p> <p>答案是否定的。Web Storage 是一个从定义到使用都非常简单的东西，它使用键值对的形式进行存储，这种模式有点类似对象，<strong>但它只能存储字符串，要想存储对象，我们还需要对对象进行序列化</strong>。</p> <p>总的来说，Local Storage 适合存储你希望进行持久化的较小数据集，比如用户偏好设置或表单数据。更大规模和更复杂的数据则适合存储在 CacheAPI 和 IndexDB 中。</p> <h2 id="cache-api"><a href="#cache-api" class="header-anchor">#</a> Cache API</h2> <p><strong>Cache 是请求-响应键/值对对象的容器</strong>。</p> <p>缓存涉及对象的离线存储，这些对象是“请求”和“响应”的键值对。Cache 接口为这些被缓存的对象提供了一种存储机制。「CacheStorage」 接口表示 Cache 对象的存储，可以存储资源以供离线使用，以及生成对请求的自定义响应。</p> <p>如果在浏览器控制台中键入 <code>Cache</code>，<code>CacheStorage</code> 和 <code>window.caches</code> 或 <code>caches</code>，则可以查看您的浏览器是否支持它们。缓存对象具有唯一的引用 ID 或 cacheName，可用于存储不同版本的缓存对象。 CacheStorage 跟踪 Cache 对象并为 CRUD 操作提供 API。</p> <h3 id="如何使用"><a href="#如何使用" class="header-anchor">#</a> 如何使用</h3> <p>Cache API 可以从 window 下文或 service worker 上下文访问缓存 API。 因此，我们可以缓存网络请求的响应，并在需要时使用它们。 它为我们提供了以下 API 方法</p> <ul><li><p><code>caches.has(cacheName)</code>
返回一个 Promise，如果存在与 cacheName 匹配的 Cache 对象，则该承诺解析为 true。 cacheName 是 CacheStorage 对象的键。</p></li> <li><p><code>caches.open()</code>
返回一个解析为与 cacheName 匹配的 Cache 对象的 Promise（如果尚不存在，则会创建一个新的缓存）</p></li> <li><p><code>caches.delete()</code>
查找与 cacheName 匹配的 Cache 对象，如果找到，则删除 Cache 对象并返回解析为 true 的 Promise。 如果未找到 Cache 对象，则返回 false。</p></li> <li><p><code>caches.keys()</code>
返回一个 Promise，该数组将使用包含 cacheName 的数组进行解析，该数组与 CacheStorage 跟踪的所有命名 Cache 对象相对应。 使用此方法可以迭代所有 Cache 对象的列表。</p></li></ul> <p>在上述某些方法中，我们获得 Cache 对象作为回报。 缓存对象还提供 API 方法来执行操作，例如添加缓存条目。 在下面，缓存是 Cache 的一个实例。</p> <ul><li><code>cache.match(request, options)</code>
返回一个 Promise，该 Promise 解析为与 Cache 对象中的第一个匹配请求关联的响应。</li> <li><code>cache.matchAll(request, options)</code>
返回一个 Promise，它解析为 Cache 对象中所有匹配请求的数组。</li> <li><code>cache.add(request)</code>
取得一个 URL，将其检索并将结果响应对象添加到给定的缓存中。</li> <li><code>cache.addAll(requests)</code>
获取一个 URL 数组，检索它们，并将结果响应对象添加到给定的缓存中。</li> <li><code>cache.put(request, response)</code>
接受请求及其响应，并将其添加到给定的缓存中。 响应是一个流。</li> <li><code>cache.delete(request, options)</code>
查找其键为请求的 Cache 条目，如果找到并删除了匹配的 Cache 条目，则返回一个 Promise，该 Promise 解析为 true。 如果未找到缓存条目，则承诺解析为 false。</li> <li><code>cache.keys(request, options)</code>
返回一个 Promise，它解析为一个 Cache 键数组。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* Add to Caches */</span>
<span class="token keyword">let</span> cacheObj<span class="token punctuation">;</span>
caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;my-cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cacheObj <span class="token operator">=</span> cache<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;buttAddCaches&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">addToCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">addToCaches</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/file_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.txt</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> stringResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token function">getStr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> cacheObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> stringResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">*** Cache API: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' ***</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Oops: Error writing to Cache API, check console.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="cache-的应用场景"><a href="#cache-的应用场景" class="header-anchor">#</a> Cache 的应用场景</h3> <p>Cache API 主要是与 Service Worker 结合，用来做 PWA 应用，也就是离线应用。</p> <h4 id="静态资源存储-2"><a href="#静态资源存储-2" class="header-anchor">#</a> 静态资源存储</h4> <p>你可以缓存网站不使用的文件，例如 offline-index.html，offline-styles.css 和其他文件以供离线查看。 当用户没有网络连接时，可以使用这些文件。 这样做的方法是使用 cache.put 方法将这些文件缓存在安装事件处理程序中。 然后在 fetch 事件处理程序中，当由于没有互联网连接而导致拒绝获取承诺时，您可以提供这些文件。</p> <p>这里是 service worker 文件，用来处理离线缓存：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cacheName <span class="token operator">=</span> <span class="token string">&quot;WWW-EXAMPLE-COM-V2&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> filesToCache <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token comment">// index.html</span>
  <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;./styles.css&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;./assets/logo.png&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 安装事件</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;install&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    <span class="token comment">// 存储</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[sw.js] cached all files&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>filesToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 假设我们已经修改了所有（可能）缓存在用户浏览器中的静态文件。 这意味着要从用户的浏览器中删除这些缓存的文件并替换为新文件。 这是激活事件有用的地方。</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;activate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cName <span class="token operator">!==</span> cacheName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 获取请求</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 请求网络</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token punctuation">{</span> credentials<span class="token punctuation">:</span> <span class="token string">&quot;include&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的 sw.js Service Worker 文件中，我们创建了 cacheName 变量来存储 Cache 对象的唯一名称。 在 filesToCache 数组中，我们存储需要缓存的文件的路径。 在 Service Worker 的 install 事件处理程序内部，我们使用具有 Promise 的 event.waitUntil 方法阻止安装。</p> <p>完整测试例子演示：pwa 例子。</p> <h4 id="内联响应"><a href="#内联响应" class="header-anchor">#</a> 内联响应</h4> <p>另外，你还可以使用 Response 构造函数来缓存内联响应。 这样，您可以最大程度地减少网络负载，但会增加 Service Worker 文件的大小。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 缓存页面，503/404</span>
<span class="token function">Response</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;h1&gt;Service Unavailable&lt;/h1&gt;&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  status<span class="token punctuation">:</span> <span class="token number">503</span><span class="token punctuation">,</span>
  statusText<span class="token punctuation">:</span> <span class="token string">&quot;Service Unavailable&quot;</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <h2 id="indexdb"><a href="#indexdb" class="header-anchor">#</a> IndexDB</h2> <p>与 Cache API 不同，IndexedDB API 是事件驱动的，而不是基于 Promise 的。这使得编写和维护 JavaScript 代码更加困难。 因此，您可以使用一些 indexeddb 包装器库，这些库可让您编写基于 promise 的代码而又不牺牲很多。 这些库为您提供了出色的 API，可以用几行代码编写长的 IndexedDB 代码。</p> <p>IndexDB 是一个<u>运行在浏览器上的非关系型数据库。</u>既然是数据库了，就不是 5M、10M 这样小打小闹的级别了。理论上来说，IndexDB 是没有存储上限的（一般来说不会小于 250 M）。它不仅可以存储<code>字符串</code>，还可以存储<code>二进制数据</code>。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-06-18-16-56-48-sql-vs-nosql.ea781706.png" alt=""></p> <h3 id="indexdb-的基本使用流程"><a href="#indexdb-的基本使用流程" class="header-anchor">#</a> IndexDB 的基本使用流程</h3> <p>在 Window 或 Service Worker 的范围内可以使用 IndexedDB 的 API。</p> <h4 id="基本示例"><a href="#基本示例" class="header-anchor">#</a> 基本示例</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>indexedDB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;IndexedDB is supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建数据库</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> self<span class="token punctuation">.</span>indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;EXAMPLE_DB&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// let db;</span>

  <span class="token comment">// onupgradeneeded 事件处理程序成功退出后，将触发 onsuccess 事件。 在 onsuccess 事件处理程序中，我们将向产品商店中添加一些产品。</span>
  request<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[onsuccess]&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 样例数据</span>
    <span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Red Men T-Shirt&quot;</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token string">&quot;$3.99&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Pink Women Shorts&quot;</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token string">&quot;$3.99&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Nike white Shoes&quot;</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token string">&quot;$300&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 从事件对象获得数据库</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span> <span class="token comment">// === request.result</span>

    <span class="token comment">// 从数据库中创建事务 transaction</span>
    <span class="token keyword">const</span> transaction <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readwrite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 为事务添加成功事件处理程序</span>
    transaction<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[Transaction] ALL DONE!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 从事务中获取 store</span>
    <span class="token comment">// 返回 IDBObjectStore 实例</span>
    <span class="token keyword">const</span> productsStore <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 插入 products data 到 productsStore</span>
    products<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">product</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> db_op_req <span class="token operator">=</span> productsStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
      db_op_req<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result <span class="token operator">==</span> product<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      db_op_req<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle error</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// count number of objects in store</span>
    productsStore<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token string">&quot;[Transaction - COUNT] number of products in store&quot;</span><span class="token punctuation">,</span>
        event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// get product with id 1</span>
    productsStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[Transaction -GET] product with id 1&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// update product with id 1</span>
    products<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Blue Men T-shirt&quot;</span><span class="token punctuation">;</span>
    productsStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>products<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[Transaction - PUT product with id 1&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// delete product with id 2</span>
    productsStore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[Transaction - DELETE] deleted with id 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;[onerror]&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 当我们尝试创建新数据库或尝试使用新版本升级数据库时，会触发onupgradeneeded 事件。 这是创建对象库的好地方</span>
  request<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// create object store from db or event.target.result</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> keyPath<span class="token punctuation">:</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// create unique index on keyPath === 'id'</span>
    store<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token string">&quot;products_id_unique&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/Web-Performance-Optimization/assets/img/2020-11-16-02-42-23.5047a9f0.png" alt=""></p> <h3 id="indexeddb-的应用场景"><a href="#indexeddb-的应用场景" class="header-anchor">#</a> IndexedDB 的应用场景</h3> <p>IndexedDB 除了跟 Cache API 一样可以用于离线应用，并且更加灵活。
Cache API 是为资源请求与响应的存储量身定做的，它采用了键值对的数据模型存储格式，以请求对象为键、响应对象为值，正好对应了发起网络资源请求时请求与响应一一对应的关系。因此 Cache API 适用于请求响应的本地存储。</p> <p>IndexedDB 则是一种非关系型（NoSQL）数据库，它的存储对象主要是数据，比如数字、字符串、Plain Objects、Array 等，以及少量特殊对象比如 Date、RegExp、Map、Set 等等，对于 Request、Response 这些是无法直接被 IndexedDB 存储的。</p> <p>可以看到，Cache API 和 IndexedDB 在功能上是互补的。在设计本地资源缓存方案时通常以 Cache API 为主，但在一些复杂的场景下，Cache API 这种请求与响应一一对应的形式存在着局限性，因此需要结合上功能上更为灵活的 IndexedDB，通过 IndexedDB 存取一些关键的数据信息，辅助 Cache API 进行资源管理。</p> <p>IndexedDB 和 CacheAPI 都适合做 PWA 应用，提升用户体验。对于 PC 端应用，这也是一种性能优化，这块笔者的实践较少，还需要进一步探索，如有想法，欢迎交流。</p> <p>一些网上开发者的经验应用：</p> <ul><li><a href="https://tech.meituan.com/2020/01/09/meituan-logan.html" target="_blank" rel="noopener noreferrer">美团开源 Logan Web：前端日志在 Web 端的实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，利用浏览器的 IndexedDB 作为本地日志的大容量存储容器。</li> <li><a href="https://blog.csdn.net/dingshi7798/article/details/105867570" target="_blank" rel="noopener noreferrer">使用IndexedDB管理3D WebGL资产<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对于 <strong>3D WebGL</strong> 的开发者来说，加载大量的 hdr、glb、gltf 等文件往往是很令人头疼的。而IndexedDB 不仅可以储存字符串，还可以储存二进制数据（ArrayBuffer 对象和 Blob 对象），所以我们可以把图片或者 3D 模型文件转化成 Blob 格式的文件，存在 IndexedDB 中，就可以解决免去二次加载时网络请求的时间。</li> <li><a href="https://www.w3.org/2018/12/games-workshop/report.zh.html" target="_blank" rel="noopener noreferrer">W3C Web 游戏技术研讨会<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>虽然浏览器永远不会取代服务器的持久化系统，但是通过多种方法在本地缓存数据可以让你的应用的性能得到大幅度的提升，而与 Vue.js 相结合则会让它更为强大。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="/Web-Performance-Optimization/reference/#网络">Web 性能优化资源合集（持续更新）</a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Jecyu/Web-Performance-Optimization/edit/master/docs/cache/browser-localStorage.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/18/2020, 3:14:55 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Web-Performance-Optimization/cache/browser-cache.html" class="prev">浏览器之 HTTP 缓存机制解读</a></span> <span class="next"><a href="/Web-Performance-Optimization/cache/webapp.html">Web 运行时缓存</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" defer></script><script src="/Web-Performance-Optimization/assets/js/2.72369abb.js" defer></script><script src="/Web-Performance-Optimization/assets/js/10.a5dacc7d.js" defer></script>
  </body>
</html>
