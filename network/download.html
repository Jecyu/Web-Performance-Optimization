<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>资源下载 | 微谈 Web 前端性能优化</title>
    <meta name="description" content="Analysis vue.js deeply">
    <link rel="icon" href="/Web-Performance-Optimization/logo.png">
  <link rel="manifest" href="/Web-Performance-Optimization/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/Web-Performance-Optimization/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/Web-Performance-Optimization/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css" as="style"><link rel="preload" href="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/2.72369abb.js" as="script"><link rel="preload" href="/Web-Performance-Optimization/assets/js/6.66c2d2c9.js" as="script"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/10.a5dacc7d.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/11.02148d24.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/12.acd7b156.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/13.837abe37.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/14.0f6e7494.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/15.b7cfaf21.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/16.18e998c2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/17.f2b51082.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/18.fd8bf8b2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/19.ac77f635.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/20.f3fb8221.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/21.b6c75ca9.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/22.5b60da5a.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/23.e8cdc260.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/24.18b6675d.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/25.81f7219b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/26.cf52eab7.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/27.892d8e46.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/28.36470c5c.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/29.94a5d762.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/3.c2cb7e60.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/30.01fe9788.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/31.21d6cc04.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/32.b9a9aea8.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/33.d303235b.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/34.0696d0a6.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/35.523a3368.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/36.3ec948c0.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/4.df7b7976.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/5.d4962001.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/7.ffbcbdd2.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/8.7a41af06.js"><link rel="prefetch" href="/Web-Performance-Optimization/assets/js/9.a97348ef.js">
    <link rel="stylesheet" href="/Web-Performance-Optimization/assets/css/0.styles.841911cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Web-Performance-Optimization/" class="home-link router-link-active"><!----> <span class="site-name">微谈 Web 前端性能优化</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Jecyu/Web-Performance-Optimization/tree/master/examples" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Web-Performance-Optimization" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/concept/" class="sidebar-link">Web 性能优化基础认知</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/tool-monitor/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/indicator.html" class="sidebar-link">解读 Web 性能体验和质量指标</a></li><li><a href="/Web-Performance-Optimization/tool-monitor/chromeDev.html" class="sidebar-link">唯快不破，Chrome DevTools 性能优化手把手教学</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>网络篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/network/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/network/request.html" class="sidebar-link">资源请求</a></li><li><a href="/Web-Performance-Optimization/network/download.html" class="active sidebar-link">资源下载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/network/download.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/network/download.html#资源压缩与合并" class="sidebar-link">资源压缩与合并</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/network/download.html#资源拆分与按需加载" class="sidebar-link">资源拆分与按需加载</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/network/download.html#图片资源的优化" class="sidebar-link">图片资源的优化</a></li><li class="sidebar-sub-header"><a href="/Web-Performance-Optimization/network/download.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/Web-Performance-Optimization/network/render.html" class="sidebar-link">资源渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>缓存篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/cache/" class="sidebar-link">介绍</a></li><li><a href="/Web-Performance-Optimization/cache/browser-cache.html" class="sidebar-link">浏览器之 HTTP 缓存机制解读</a></li><li><a href="/Web-Performance-Optimization/cache/browser-localStorage.html" class="sidebar-link">浏览器之本地存储——Cookie、Web Storage、IndexedDB</a></li><li><a href="/Web-Performance-Optimization/cache/webapp.html" class="sidebar-link">Web 运行时缓存</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>渲染篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/browser/" class="sidebar-link">浏览器背后的运行机制</a></li><li><a href="/Web-Performance-Optimization/browser/render.html" class="sidebar-link">浏览器渲染过程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>应用篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/action/bigData.html" class="sidebar-link">大数据量的渲染优化</a></li><li><a href="/Web-Performance-Optimization/action/code.html" class="sidebar-link">代码层面的优化</a></li><li><a href="/Web-Performance-Optimization/action/chart.html" class="sidebar-link">图表的性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>参考资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Web-Performance-Optimization/reference/" class="sidebar-link">Web 性能优化资源合集（持续更新）</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="资源下载"><a href="#资源下载" class="header-anchor">#</a> 资源下载</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>经过了一系列的网络请求过程，资源到了 Content Download 的过程，如下图的蓝色线条。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-05-21-48-48-network-timing.3ed3830c.png" alt=""></p> <p>假如此时我们要优化 Web 应用的首屏渲染，从资源下载的角度应该如何入手呢？假如首屏要下载 10 个资源 5s，如何优化到 1s 内呢？</p> <p><strong>单个资源下载的耗时 = 资源大小/用户网速</strong>。</p> <p>用户网速我们无法控制的，那么资源的瓶颈就显而易见：<strong>资源大小</strong>。这样只要减少单个资源的大小，就可以减少单个资源下载的耗时。另外，我们还可以设法通过合并资源以及懒加载某些资源达到请求次数的减少，从而减少总的耗时。</p> <p><strong>总资源下载的耗时 = 资源数量 * 单个资源下载的耗时</strong>。</p> <p>可见，HTTP 优化两个大的方向：减少请求次数和减少单次请求所花费的时间，这是全文的主要内容。文中会使用构建工具 webpack 4.x 作为说明，但对于其他构建工具来说优化思想是一致的。</p> <p><strong>目标读者</strong>：希望了解如何减少 Web 资源下载的时间。</p> <p><strong>文章大纲</strong>：</p> <ul><li>资源压缩与合并</li> <li>资源拆分与按需加载
<ul><li>文件依赖可视化分析</li> <li>删除冗余代码</li> <li>抽离公共代码</li> <li>polyfill
</li></ul></li> <li>图片资源的优化</li></ul> <p><strong>阅读时长</strong>：30min</p> <h2 id="资源压缩与合并"><a href="#资源压缩与合并" class="header-anchor">#</a> 资源压缩与合并</h2> <p>要减少请求次数和体积，首先要做的就是文件资源的合并与压缩。</p> <h3 id="压缩"><a href="#压缩" class="header-anchor">#</a> 压缩</h3> <p>我们来看看开启了资源的压缩的请求是怎么样？可以看到 size 有两个不同大小 和 Content-Encoding 值为 gzip 的列。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-07-14-29-48-gzip-network.2ae3608e.png" alt=""></p> <h4 id="http-是如何支持传输压缩文件的呢？"><a href="#http-是如何支持传输压缩文件的呢？" class="header-anchor">#</a> HTTP 是如何支持传输压缩文件的呢？</h4> <p>因为服务器会对资源进行压缩后再传输，所以浏览器需要知道服务器压缩的方法。HTTP/1.1 是通过请求头和响应头来进行协商，在发起请求时候会通过 HTTP 请求头 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" target="_blank" rel="noopener noreferrer">Accept-Encoding<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 告诉服务器它期待服务器返回的文件采取的压缩形式</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Accept: text/html 返回文件的类型</span>
Accept-Encoding: gzip, deflate, br <span class="token comment"># 文件采用的压缩方式，优先 gzip</span>
<span class="token comment"># Accept-Charset: ISO-8859-1, utf-8 # 文件的编码</span>
<span class="token comment"># Accept-Language: zh-CN,zh # 文件的语言，优先中文</span>
</code></pre></div><p>这个请求头一般是浏览器自动添加的。兼容的浏览器将在下载所需的格式前声明支持何种方法给服务器；不支持压缩方法的浏览器将下载未经压缩的数据。</p> <p>服务器接收到浏览器发送过来的请求头信息之后，会根据请求头的信息来准备响应数据。不过有时候会有一些意外情况发生，比如浏览器请求的压缩类型是 gzip，但是服务器不支持 gzip，只支持 br 压缩，那么它会通过响应头中的 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html" target="_blank" rel="noopener noreferrer">Content-Encoding<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 字段告诉浏览器最终的压缩类型，也就是说最终浏览器需要根据响应头的信息来处理数据。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Content-Encoding: br <span class="token comment"># 表示服务器采用了 br 的压缩方法</span>
<span class="token comment"># Content-Type: text/html; charset=UTF-8 # 表示返回 html 文件，编码类型为 UTF-8</span>
</code></pre></div><p>有了响应头的信息，浏览器就会使用 br 方法来解压文件，再按照 UTF-8 的编码格式来处理原始文件，最后按照 HTML 的方式来解析该文件。</p> <h4 id="构建结果压缩"><a href="#构建结果压缩" class="header-anchor">#</a> 构建结果压缩</h4> <p>如果客户端和服务端都支持 HTTP 压缩的情况下，浏览器展示的文件包括 HTML 文本、JS 脚本以及 CSS 样式文件、图片等，这些资源在服务器发送给浏览器前就是已经压缩好的了。</p> <p>一般来说，Gzip 压缩是服务器的活儿：服务器了解到我们这边有一个 Gzip 压缩的需求，它会启动自己的 CPU 去为我们完成这个任务。
下面是使用 Node.js 实现一个 demo：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">DOCUMENT_ROOT</span> <span class="token operator">=</span> <span class="token string">&quot;./app&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DIRECTORY_INDEX</span> <span class="token operator">=</span> <span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">9993</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> zlib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;zlib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Remove query strings from uri</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span>url <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Remove query strings from uri</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token constant">DIRECTORY_INDEX</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token constant">DOCUMENT_ROOT</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>

    <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> acceptEncoding <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;accept-encoding&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acceptEncoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      acceptEncoding <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exists</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> raw <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptEncoding<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\bdeflate\b/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">&quot;content-encoding&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;deflate&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">createDeflate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptEncoding<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\bgzip\b/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">&quot;content-encoding&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gzip&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不压缩</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Serving files on http://localhost:&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>压缩文件这个过程本身是需要耗费时间的，我们可以理解为<u>以服务器压缩的时间开销和 CPU 开销（以及浏览器解析压缩文件的开销）为代价，省去了一些传输过程中的时间开销。</u></p> <p>既然存在着这样的交换，那么就要求我们学会权衡。服务器的 CPU 性能不是无限的，如果存在大量的压缩需求，服务器也扛不住的的。服务器一旦因此慢下来了，用户还是要等。</p> <p>说到压缩，可不只是服务端的专利。我们日常开发中，还可以在客户端构建层面比如通过 Webpack 开启 Gzip 压缩处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue.config.js</span>
<span class="token keyword">const</span> CompressionPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;compression-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> productionGzipExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">CompressionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  filename<span class="token punctuation">:</span> <span class="token string">&quot;[path].gz[query]&quot;</span><span class="token punctuation">,</span>
  algorithm<span class="token punctuation">:</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 压缩算法</span>
  test<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&quot;\\.(&quot;</span> <span class="token operator">+</span> productionGzipExtensions<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 压缩的资源</span>
  threshold<span class="token punctuation">:</span> <span class="token number">10240</span><span class="token punctuation">,</span> <span class="token comment">// 资源大于 10240B = 10 KB 时会被压缩</span>
  minRatio<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token comment">// 压缩比率</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/Web-Performance-Optimization/assets/img/2020-06-26-22-37-25-gzip.16f2c6a1.png" alt=""></p> <p>上图是 webpack 对 JS、CSS 开启了 gzip 的压缩。画框中的 JS 源文件为 1.3MB，压缩后为 343 KB，压缩率达到 70% 以上。</p> <p>Webpack 中 Gzip 压缩操作的存在，事实上就是为了在构建过程中去做一部分服务器的工作，为服务器分压。</p> <p>因此，这两个地方的 Gzip 压缩，谁也不能替代谁。作为开发者，我们也应该结合业务压力的实际情况，去做好其中的权衡。</p> <h5 id="该不该用-gzip"><a href="#该不该用-gzip" class="header-anchor">#</a> 该不该用 Gzip</h5> <p>如果你的项目不是极端的迷你超小型文件，都可以试试 Gzip。</p> <p>有的同学或许存在这样的疑问：压缩 Gzip，服务端要花时间；解压 Gzip，浏览器要花时间。中间节省出来的传输时间，真的那么可观吗？</p> <p>答案是肯定的。如果你手上的项目是 1k、2k 的小文件，那确实是有点高射炮打蚊子的意思。但更多的时候，我们处理的都是具备一定规模的项目文件。实践证明，这种情况下压缩和解压缩带来的传输过程中节省下的时间开销来说，可以说是微不足道的。</p> <p>假如一个 5M 大小的文件，在宽带速率为 500 多 k/s 的网络下，宽带速率不高的情况下，足以需要 10 s 左右。假如使用 gzip 压缩后可以减少到 2M 左右，时间上可以减少到 3、4s。</p> <h5 id="gzip-是万能的吗？"><a href="#gzip-是万能的吗？" class="header-anchor">#</a> Gzip 是万能的吗？</h5> <p>首先要承认 Gzip 是高效的，压缩后通常能帮我们减少响应 70% 左右的大小。</p> <p>但它并非万能的。Gzip 并不保证针对每一个文件的压缩都会使其变小。（图片则不行）</p> <p>Gzip 压缩背后的原理，<u>是在一个文本文件中找出一些重复出现的字符串、临时替换它们，从而使整个文件变小。</u>根据这个原理，文件中代码的重复率越高，那么压缩的效率就越高，使用 Gzip 的收益也就越大。反之亦然。详细可以参考 <a href="https://blog.csdn.net/imquestion/article/details/16439" target="_blank" rel="noopener noreferrer">gzip 原理与实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h5 id="资源加载-gzip-处理"><a href="#资源加载-gzip-处理" class="header-anchor">#</a> 资源加载 gzip 处理</h5> <p>Tomcat 9.0+</p> <p>#静态资源：寻找压缩文件 #前端先压缩好文件
// vue.config.js
const CompressionPlugin = require(&quot;compression-webpack-plugin&quot;);</p> <p>const productionGzipExtensions = [&quot;js&quot;, &quot;css&quot;];</p> <p>new CompressionPlugin({
filename: &quot;[path].gz[query]&quot;,
algorithm: &quot;gzip&quot;, // 压缩算法
test: new RegExp(&quot;\.(&quot; + productionGzipExtensions.join(&quot;|&quot;) + &quot;)$&quot;), // 压缩的资源
threshold: 10240, // 资源大于 10240B = 10 KB 时会被压缩
minRatio: 0.8, // 压缩比率
});
#Tomcat 配置
Tomcat 默认已经开启支持寻找预先压缩的文件。 ，只需要修改 conf/web.xml 文件，添加以下配置即可。</p> <pre><code>&lt;servlet&gt;
    ...
    &lt;servlet-name&gt;default&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;gzip&lt;/param-name&gt;
        &lt;param-value&gt;true&lt;/param-value&gt;
    &lt;/init-param&gt;
    ...
&lt;/servlet&gt;
</code></pre> <p>#针对 API 动态资源请求：实时压缩
修改 server.xml，并进行 tomcat 的重启。</p> <p>before</p> <Connector port="8080" protocol="HTTP/1.1" compression="on" compressibleMimeType="text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml" compressionMinSize="2048"></Connector> <p>After 添加 useSendfile，和设置端口为 80，其他端口设置待研究。</p> <pre><code>&lt;Connector port=&quot;80&quot; protocol=&quot;HTTP/1.1&quot; compression=&quot;on&quot; compressibleMimeType=&quot;text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml&quot;  compressionMinSize=&quot;2048&quot; useSendfile=&quot;false&quot; /&gt;
</code></pre> <p>这里要注意的是：port 为 80 而不是 8080，另外一定要添加 useSendfile 属性并设置为 false，否则有可能不会压缩。这个 useSendfile 属性来保护 CPU 使用率，详情可以看对应的 tomcat 配置文档（connector 部分）。</p> <p>connector 的作用主要是拦截请求，进行响应。</p> <p>访问地址： http:80//localhost/dist-notzip</p> <p>而不是 http:8080//localhost/dist-notzip</p> <h1 id=""><a href="#" class="header-anchor">#</a></h1> <h4 id="运行时压缩"><a href="#运行时压缩" class="header-anchor">#</a> 运行时压缩</h4> <p>除了对构建的结果进行压缩外，还有一些是在系统运行时需要动态压缩的。比如用户上传图片、音频、视频等。</p> <p><img src="/Web-Performance-Optimization/assets/img/fe-zip.be274cfb.png" alt=""></p> <ul><li><p>有损压缩</p> <ul><li>主要用于图像压缩
<ul><li>用户自拍图片</li> <li>验证信息的图片</li></ul></li> <li>方式
<ul><li>基于 canvas API，<code>canvas.toBlob(callback, mimeType, quality)</code> 可以参考 <a href="https://juejin.im/post/6844903495703904263#heading-8" target="_blank" rel="noopener noreferrer">前端图片压缩上传（压缩篇）：可能是最适合小白的前端图片压缩文章了！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></li> <li><p>无损压缩</p> <ul><li>数据压缩，文本压缩
<ul><li>用户操作大量数据后本地保存数据，上传数据</li> <li>选择文件夹上传之前进行压缩</li></ul></li> <li>压缩原理：任意一个非随机文件都含有重复数据，这些重复数据可以通过用来确定字符出现概的统计建模来压缩。</li> <li>方式：
<ul><li>遵循 <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78" target="_blank" rel="noopener noreferrer">LZ-<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 开头压缩算法的方案，比如开源库 jszip。</li> <li>利用 png 无损压缩，使用 canvas 绘制像素，输出为 png 格式。</li></ul></li></ul></li></ul> <p>上面提到的都是上传、下载文件之前先进行完整的压缩，那么能否边上传边压缩呢？一个取巧的方式是把大的文件分片压缩，分片传输，通过 HTTP Chunk transfer 机制。</p> <p>对于边下载边解压，详细参考 <a href="https://mp.weixin.qq.com/s/NB12KQOHjso9wH8Ju1ueSA" target="_blank" rel="noopener noreferrer">ZIP 也能边下载边解压？流式解压技术揭秘<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p> <h3 id="合并"><a href="#合并" class="header-anchor">#</a> 合并</h3> <p>资源的压缩是为了减少文件的体积，资源的合并则是为了减少 HTTP 请求次数。假如有三个 JS 文件，分别为 a.js，b.js，c.js，现在通过 HTTP 进行传输如下图：</p> <p><img src="/Web-Performance-Optimization/assets/img/file-merge.drawio.4448eca2.svg" alt=""></p> <p>通过上图对比，合并请求的优点：</p> <ul><li>减少文件之间可能会插入其他的请求导致 TCP 队列阻塞的频率。</li> <li>减少 HTTP 请求次数较多。</li></ul> <p>资源的合并一般是在构建阶段，使用 Node.js 进行文件合并，以 webpack 为例：</p> <p>a.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre></div><p>b.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
</code></pre></div><p>c.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">multiply</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
</code></pre></div><p>main.js 作为 webpack 入口</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./a&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sub <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./b&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> multiply <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./c&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;add(1 + 2) = &quot;</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sub(1 - 2) = &quot;</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;multiply(1 + 2) = &quot;</span><span class="token punctuation">,</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>webpack 的配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// &quot;webpack&quot;: &quot;4.44.2&quot;,</span>
<span class="token comment">// &quot;webpack-cli&quot;: &quot;3.3.12&quot;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过上面的配置可以把 a、b、c 文件打包合并为一个文件，然后进行加载使用。</p> <p>虽然说资源合并很有必要，但是文件的合并也有缺点。</p> <ul><li><strong>首屏渲染问题</strong>。特别是对于单页面应用来说，一个脚本文件过大的话会影响首次渲染的速度。（在没有做服务端渲染的情况下），另外首屏加载指的是浏览器上首次加载的页面，不仅仅是首页，有可能用户第一次浏览的是商品详情页、关于我们页等。</li> <li><strong>缓存失效</strong>。假如合并前 a 文件改变只会造成 a 文件缓存失效，但是合并后，a 文件内容改变，会造成 bundle.js 文件全部内容缓存失效。</li></ul> <p>因此，我们需要在合适的场景下合并文件，比如不同页面的合并、一些公共库、工具类的合并。</p> <h2 id="资源拆分与按需加载"><a href="#资源拆分与按需加载" class="header-anchor">#</a> 资源拆分与按需加载</h2> <p>鉴于前面说过资源合并的一些缺点，我们有必要考虑对某些合并的资源进行拆分，一来可以减小单个合并文件的大小，二来可以对多个文件进行按需加载。</p> <h3 id="文件结构可视化，找出导致体积过大的原因"><a href="#文件结构可视化，找出导致体积过大的原因" class="header-anchor">#</a> 文件结构可视化，找出导致体积过大的原因</h3> <p>在做进一步的拆分优化之前，可以借助一个非常好用的可视化工具——<a href="https://www.npmjs.com/package/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer">webpack-bundle-analyzer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，配置方法和普通的 plugin 无异，它会以矩形树图的形式将包内各个模块的大小和依赖关系呈现出来，格局如官方所提供这张图所示：</p> <p><img src="/Web-Performance-Optimization/assets/img/webpack-bundler-analysizer-gif.76eb1584.gif" alt=""></p> <p>在使用时，我们只需要将其以插件的形式引入，注意是放到生产环境的 webpack 配置中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.prod.js</span>
<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-bundle-analyzer&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>然后在 yarn build：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">yarn</span> build

The build folder is ready to be deployed.
Webpack Bundle Analyzer is started at http://127.0.0.1:8888
</code></pre></div><p>在 vuecli 项目中，只需要 <code>yarn build --report</code> ，也就是跑 <code>vue-cli-service build --report</code> 的命令，即可快速查看。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build --report&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="删除冗余代码"><a href="#删除冗余代码" class="header-anchor">#</a> 删除冗余代码</h3> <p>删除冗余的代码可以通过 <code>Tree-Shaking</code>，它在保持代码运行结果不变的前提下，去除无用的代码。这样的好处是：</p> <ul><li>减少程序的体积。</li> <li>减少程序执行的时间。</li></ul> <p>从 webpack2 开始，webpack 原生支持了 ES6 的模块系统，并基于此推出了 <a href="https://webpack.js.org/guides/tree-shaking/" target="_blank" rel="noopener noreferrer">Tree-Shaking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Tree Shaking 最先在 Rollup 中出现）。</p> <blockquote><p>Tree shaking is a term commonly used in the JavaScript context for dead-code elimination, or more precisely, live-code import. It relies on ES2015 module import/export for the static structure of its module system.</p></blockquote> <p>由于 Tree-Shaking 是基于静态模块分析的，意思像 CommonJS、AMD 模块这种运行时（导出对象）是不支持的，但支持基于 import/export（导出代码） 的语法，Tree-Shaking 可以在编译的过程中获悉哪些模块并没有真正被使用，这些没用的代码，在最后打包的时候会被去除。关于 ES6 模块化，可以看 <a href="https://es6.ruanyifeng.com/#docs/module" target="_blank" rel="noopener noreferrer">Module 的语法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-10-12-30-17.5d8c71b6.png" alt=""></p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-10-12-30-25.5eb565be.png" alt=""></p> <p>拿前面资源合并的例子来说：</p> <p>a.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre></div><p>b.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
</code></pre></div><p>c.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">multiply</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
</code></pre></div><p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./a&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sub <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./b&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> multiply <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./c&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;add(1 + 2) = &quot;</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sub(1 - 2) = &quot;</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -1</span>
<span class="token comment">// console.log(&quot;multiply(1 * 2) = &quot;, multiply(1, 2)); // 2</span>
</code></pre></div><p>因为 multiply 没有被用到，所以打包的结果里会把 multiply 的部分去掉。</p> <p><strong>那么要如何接入 Tree Shaking 呢？</strong></p> <p>Tree Shaking 具体的过程分为两步：</p> <ol><li>webpack 负责对代码进行标记，把 import &amp; export 标记为 3 类。
<ul><li>所有 import 标记为 / harmony /</li> <li>被使用过的 export 标记为 / harmony export ([type])/，其中 [type] 和 webpack 内部有关，可能是 binding，immutable 等。</li> <li>没被使用过的 import 标记为 / harmony export [FuncName]，其中 [FuncName] 为 export 的方法名称。</li></ul></li> <li>然后在 Uglifyjs（或其他类似的工具）进行代码精简，把没用的代码删掉。</li></ol> <p>配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">//   mode: &quot;production&quot;,</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    usedExports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>然后进行打包命令输出如下（其中可以通过 --display-used-exports 参数在命令行查看 export 使用的情况）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ....</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \&quot;a\&quot;, function() { return add; });\nconst add = (a, b) =&gt; a + b;\n\n//# sourceURL=webpack:///./a.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/***/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token string">&quot;./b.js&quot;</span><span class="token punctuation">:</span>
<span class="token comment">/***/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \&quot;a\&quot;, function() { return sub; });\nconst sub = (a, b) =&gt; a - b;\n \n\n//# sourceURL=webpack:///./b.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/***/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">/***/</span> <span class="token string">&quot;./c.js&quot;</span><span class="token punctuation">:</span>
<span class="token comment">/***/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;/* unused harmony export multiply */\nconst multiply = (a, b) =&gt; a * b;\n\n\n//# sourceURL=webpack:///./c.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/***/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment">// ... 省略</span>
</code></pre></div><p>之后再通过 Uglifyjs 处理即可，Webpack Tree shaking 会对多层调用的模块进行重构，提取其中的代码，简化函数的调用结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;add(1 + 2) = &quot;</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sub(1 - 2) = &quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> e <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//</span>
</code></pre></div><p>在生产环境下配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 会进行 Tree Shaking 和压缩代码</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    usedExports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里提一下，我们引入第三方库时，不要引入整个 JavaScript 对象，而是按需引入包。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Import everything (NOT TREE-SHAKBLE)</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// Import named export (CAN BE TREE SHAKEN)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> debounce <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 或者这样引入 (CAN BE TREE SHAKEN)</span>
<span class="token keyword">import</span> debounce <span class="token keyword">from</span> <span class="token string">&quot;lodash/lib/debounce&quot;</span><span class="token punctuation">;</span>
</code></pre></div> <h3 id="抽离公共代码"><a href="#抽离公共代码" class="header-anchor">#</a> 抽离公共代码</h3> <p>去掉无用的代码后，我们要考虑如何抽离页面中公共的代码，主要针对<strong>单页面应用</strong>，包括三部分：</p> <ul><li>抽离第三方库</li> <li>业务代码的处理</li> <li>polyfill</li></ul> <h4 id="抽离第三方库"><a href="#抽离第三方库" class="header-anchor">#</a> 抽离第三方库</h4> <p>第三方库一般比较稳定，而业务代码可能会频繁变更。</p> <p>所以，如果不抽离打包，业务变动后，用户需要重新下载全部的代码：</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-00-34-39-split-lib.198e1e25.png" alt=""></p> <p>而抽离第三方库进行打包则只需要下载变更的业务代码，因为第三方库的 hash 值没有变化，就会从缓存中获取。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-00-36-24-split-lib-2.5066e207.png" alt=""></p> <p>在 vue-cli 中，只要是通过 node_module 引入的模块，都被打包进类似 <code>chunk-vendors-hash</code> 的文件里，如果引入的第三方依赖很多，这个文件也会很大，这个时候可以借助 webpack-bundle-analyzer 进行分析是否有没必要的依赖（包括检查依赖的依赖，像国际化之类的文件）。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-07-14-16-12-31-webpack-analyzer.3b8ad002.png" alt=""></p> <p>实际上的 vuecli 中 webpack 配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// code splitting</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  webpackConfig<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span><span class="token function">splitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 找到 chunk 中共享的模块,取出来生成单独的 chunk</span>
    cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存公共代码</span>
      vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 抽离第三方插件</span>
        name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chunk-vendors</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        test<span class="token punctuation">:</span> <span class="token regex">/[\\/]node_modules[\\/]/</span><span class="token punctuation">,</span> <span class="token comment">// 指定是node_modules下的第三方包</span>
        priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 抽取优先级，数值越大越优先处理</span>
        chunks<span class="token punctuation">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span> <span class="token comment">// async表示抽取异步模块，all表示对所有模块生效，initial表示对同步模块生效 a</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <h4 id="拆分业务代码按需加载"><a href="#拆分业务代码按需加载" class="header-anchor">#</a> 拆分业务代码按需加载</h4> <p>在 SPA 单页面应用中，一般情况下都会存在很多路由，而我们每次访问其实只访问一个路由，因此可以将代码按路由代码拆分并进行按需加载，这样就减少了首屏资源加载的数量。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-01-15-30-router-split.041c8116.png" alt=""></p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-01-19-03-route.3562d61a.png" alt=""></p> <p>如何配置呢？</p> <p>懒加载函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的注释会被 webpack 自动识别处理</span>
  <span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;lodash&quot; */</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> _ <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      element<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webpack&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;An error occurred while loading the component&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>webpack 配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">&quot;[name].bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chunkFilename: '[name].bundle.js'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 动态加载</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    usedExports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>更多配置可以参考 webpack 官网 <a href="https://webpack.js.org/guides/code-splitting/#root" target="_blank" rel="noopener noreferrer">code-splitting<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>可以看这个例子。/network/demo03</p> <h4 id="抽离业务代码的公共模块"><a href="#抽离业务代码的公共模块" class="header-anchor">#</a> 抽离业务代码的公共模块</h4> <p>前面提到单页面应用按路由拆分模块包，其中存在一个问题是，如果存在公共模块，那么在每一个拆分出来的路由模块都会加载这个公共模块。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-01-28-18.e5acacb8.png" alt=""></p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-01-26-51-code-split.a6800f72.png" alt=""></p> <p>具体配置如下</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">//分割代码块</span>
      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">//缓存组 缓存公共代码</span>
        common<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chunk-common</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
          chunks<span class="token punctuation">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
          reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div> <h3 id="polyfill"><a href="#polyfill" class="header-anchor">#</a> polyfill</h3> <p>现在 ES2020 发布了，但是依然有许多老旧浏览器占领市场，所以我们依然需要对这部分浏览器作兼容性处理。</p> <p>优化方案可以：</p> <ul><li>@babel/preset-env 按需加载</li> <li>@babel/plugin-transform-runtime。
<ul><li>babel 在每个需要的文件的顶部都会插入一些 helpers 代码，这可能会导致多个文件都会有重复的 helpers 代码。 @babel/plugin-transform-runtime 的 helpers 选项就可以把这些模块抽离出来</li></ul></li></ul> <p>具体优化可以参考：<a href="https://github.com/Weiyu-Chen/blog/issues/5" target="_blank" rel="noopener noreferrer">Show me the code，babel 7 最佳实践！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="图片资源的优化"><a href="#图片资源的优化" class="header-anchor">#</a> 图片资源的优化</h2> <p>前面说的均是对代码资源进行处理，虽然说 JS 和 CSS 更快下载完成很重要，但是让图片这种用户直观可见的资源更快展示也至关重要。</p> <p>对于图片资源的优化来说，我们更多是在成像质量与体积做选择。</p> <h4 id="jpeg-jpg"><a href="#jpeg-jpg" class="header-anchor">#</a> JPEG/JPG</h4> <p>关键字：有损压缩、体积小、加载快、不支持透明</p> <h5 id="jpg-的优点"><a href="#jpg-的优点" class="header-anchor">#</a> JPG 的优点</h5> <p>JPG 最大的特点是<strong>有损压缩</strong>。这种高效的压缩算法使它成为了一种非常轻巧的图片格式。另一方面，即使被称为“有损”压缩，JPG 的压缩方式仍然是一种高质量的压缩方式：当我们把图片体积压缩至原有体积的 50% 以下时，JPG 仍然可以保持住 60% 的品质。此外，JPG 格式以 24 位存储单个图，可以呈现多达 1600 万种颜色，足以应对大多数场景下对色彩的要求，这一点决定了它压缩前后的质量损耗并不容易被我们人类的肉眼所察觉——前提是你用对了业务场景。</p> <h5 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h5> <p>JPG 使用于呈现色彩丰富的图片，在我们日常开发中，JPG 图片经常作为大的背景图、轮播图或 Banner 图出现。</p> <p>可以查看京东首页和淘宝首页。</p> <h4 id="jpg-的缺陷"><a href="#jpg-的缺陷" class="header-anchor">#</a> JPG 的缺陷</h4> <p>有损压缩在上文所展示的轮播图上确实很难露出马脚，但当它处理<strong>矢量图形</strong>和 <strong>Logo</strong> 等线条感较强、颜色对比强烈的图像时，人为压缩导致的图片模糊会相当明显。</p> <p>此外，JPEG 图像不支持透明度处理，透明图片需要召唤 PNG 来呈现。</p> <h3 id="png-8-与-png-24"><a href="#png-8-与-png-24" class="header-anchor">#</a> PNG-8 与 PNG-24</h3> <p>关键字：无损压缩、质量高、体积大、支持透明</p> <h4 id="png-的优点"><a href="#png-的优点" class="header-anchor">#</a> PNG 的优点</h4> <p>PNG（可移植网络图形格式）是一种无损压缩的高保真的图片格式。8 和 24，这里都是二进制数的位数。我们前置知识提到的对应关系，8 位的 PNG 最多支持 256 种颜色，而 24 位的可以呈现约 1600 万种。</p> <p>PNG 图片具有比 JPG 更强的色彩表现力，对<code>线条</code> 的处理更加细腻，对透明度有良好的支持。它弥补了上文我们提到的 JPG 的局限性，唯一的 BUG 就是<strong>体积太大。</strong></p> <h4 id="png-8-与-png-24-2"><a href="#png-8-与-png-24-2" class="header-anchor">#</a> PNG-8 与 PNG-24</h4> <p>如何确定一张图片是该用 PNG-8 还是 PNG-24 去呈现呢？好的做法是把图片先按照这两种格式分别输出，看 PNG-8 输出的额吉锅是否带来肉眼可见的质量损耗，并且确认这种损耗是否在我们（尤其是 UI 设计师）可接受的范围内，基于对比的结果去判断。</p> <h5 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h5> <p>前面我们提到的，复杂的、色彩层次丰富的图片，用 PNG 来处理的话，成本（体积大）会比较高，我们一般会交给 JPG 去存储。</p> <p>考虑到 PNG 在处理<code>线条</code>和<code>颜色对比度</code>方面的优势，我们主要用它来呈现小的 Logo、颜色简单且对比强烈的图片或背景等。（这里是否更应该使用 svg 呢？）</p> <p>淘宝首页、</p> <h4 id="svg"><a href="#svg" class="header-anchor">#</a> SVG</h4> <p>关键字：文本文件、体积小、不失真、兼容性好。</p> <h5 id="svg-的特性"><a href="#svg-的特性" class="header-anchor">#</a> SVG 的特性</h5> <p>和性能关系最密切的一点就是：SVG 与 PNG 和 JPG 相比，<u>文件体积更小，可压缩性更强。</u></p> <p>当然，作为矢量图，它最显著的优势还是在于<u>图片可无限放大而不失真</u>这一点上。这使得 SVG 即使被放到视网膜屏幕上，也可以一如既往地展现比较好的成像品质——1 张 SVG 足以适配 n 种分辨率。（jpg、png 得输出多个大小的图片）</p> <p>此外，<u>SVG 是文本文件</u>。我们既可以像写代码一样定义 SVG，把它写在 HTML 里、成为 DOM 的一部分，也可以把图形的描述写入以 <code>.svg</code> 为后缀的独立文件（SVG 文件在使用上与普通图片文件无异）。这使得 SVG 文件可以被非常多的工具读取和修改，具有较强的<code>灵活性</code>。</p> <p>SVG 的局限性，<u>一方面是它的渲染成本比较高，这点对性能来说是很不利的。</u>另一方面，SVG 存在着其他图片格式所没有的学习成本。（它是可编程的）。</p> <h4 id="应用场景-2"><a href="#应用场景-2" class="header-anchor">#</a> 应用场景</h4> <p>SVG 是文本文件，我们既可以像写代码一样定义 SVG，把它写在 HTML 里、成为 DOM 的一部分，也可以把对图形的描述写入以 .svg 为后缀的独立文件（SVG 文件在使用上与普通图片文件无异）。</p> <p>将 SVG 写入 HTML：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2000/svg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>将 SVG 写入独立文件后引入 HTML:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>文件名.svg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div> <h4 id="base64"><a href="#base64" class="header-anchor">#</a> Base64</h4> <p>关键字：文本文件、依赖编码、小图标解决方案</p> <p>Base64 并非一种图片格式，而是一种编码方式。Base64 和雪碧图一样，是作为小图标解决方案而存在的。</p> <p>和雪碧图一样，Base64 图片的出现，也是为了<u>减少加载网页图片时对服务器的请求次数，</u>从而提升网页性能。<strong>Base64 是作为雪碧图的补充而存在的</strong>。</p> <p>Base64 是一种用于传输 8 Bit 字节码的编码方式，通过对图片进行 Base64 编码，<code>我们可以直接将编码结果（base64字符）写入 HTML 或 CSS，从而减少 HTTP 请求的次数</code>。</p> <p>浏览器自动将 Base64 字符串解码为一个图片，而不需要再去发送 HTTP 请求。</p> <p>为什么不把大图也换成 base64 呢？这是因为 base64 编码后，图片大小会膨胀为原文件的 4/3（这是由 Base64 的编码原理决定的）。如果我们把大图也编码到 HTML 或 CSS 文件中，后者的体积会明显增加，基本我们减少了 HTTP 请求，也无法弥补这庞大的体积带来的性能开销，得不偿失。（可以通过 performance 测试）</p> <p>在传输非常小的图片时候，Base64 带来的体积膨胀、以及<code>浏览器解析 Base64</code> 的时间开销，与它节省掉的 HTTP 请求开销相比，可以忽略不计，这时候才真正体现出它在性能方面的优势。</p> <h5 id="base64-编码工具推荐"><a href="#base64-编码工具推荐" class="header-anchor">#</a> Base64 编码工具推荐</h5> <p>这里最推荐的是利用 webpack 来进行 Base64 的编码——webpack 的 url-loader 非常聪明，它除了具备基本的 Base64 转码能力，还可以结合文件大小，帮我们判断图片是否有必要进行 Base64 编码。</p> <h3 id="webp"><a href="#webp" class="header-anchor">#</a> webp</h3> <p>Webp 像 JPEG 一样对细节丰富的图片信手拈来，像 PNG 一样支持透明，像 GIF 一样可以显示动图——它集多种图片文件格式的优点于一身。</p> <p>IE11+，我们不得不考虑对浏览器兼容性对预判。</p> <h3 id="vue-项目如何更好地导出蓝湖上的图片、图标"><a href="#vue-项目如何更好地导出蓝湖上的图片、图标" class="header-anchor">#</a> vue 项目如何更好地导出蓝湖上的图片、图标</h3> <ul><li>雪碧图（后续修改不好维护）</li> <li>svg 文本文件。</li> <li>base64</li> <li>iconf</li></ul> <p>对于小的图标、矢量图，直接导出 svg 为首，结合 <code>svg-sprite-loader</code> 处理，容易维护管理。</p> <p>而对于大的图片，需要透明度则考虑 png，否则采取 jpg，做进一步的压缩。</p> <h4 id="图片的优化"><a href="#图片的优化" class="header-anchor">#</a> 图片的优化</h4> <h5 id="图片压缩"><a href="#图片压缩" class="header-anchor">#</a> 图片压缩</h5> <p>一般 ui 设计师导出来的图片都是超高清的，放到网站时需要进行一定的压缩，避免图片过大，不应该超过 1M。</p> <p><strong>在线压缩网站</strong></p> <ul><li>https://www.picdiet.com/zh-cn Picdiet 是一款在线批量压缩图片神器，它不需要后端服务器或者 API 的支持，仅通过你的浏览器来压缩图片大小，这意味着它压缩图片极快并且不会导致隐私或敏感图片泄漏。</li> <li>熊猫 https://tinypng.com/，压缩比很高。</li></ul> <p><strong>webpack 构建时压缩</strong></p> <p>更好的方案是在 Webpack 构建时进行压缩，通过 loader 或者 plugin 来处理。</p> <p>可以使用 <a href="https://www.npmjs.com/package/image-webpack-loader" target="_blank" rel="noopener noreferrer">image-webpack-loader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 <a href="https://www.npmjs.com/package/imagemin-webpack-plugin" target="_blank" rel="noopener noreferrer">imagemin-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>通过 webpack loader 或 plugin 构建时压缩挺好的，不过会可能会拖慢打包时间，特别是自动化部署时，线上安装压缩包的依赖慢（image-webpack-loader 3.56MB）。</p> <p>另外对于 vuecli 项目中，只有在 src 里的被引入的文件才会经过打包处理，换言之，直接通过 ajax 请求的 public 里的图片是不会被打包压缩的。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-12-23-02-51.6aef5de4.png" alt=""></p> <p>因此需要多方考虑，比如可以通过 tinypng 批量压缩项目里的图片文件，约定使用压缩图的规范。或让设计师直接导出分辨率相对低点的图片。</p> <h5 id="图片加载"><a href="#图片加载" class="header-anchor">#</a> 图片加载</h5> <p>图片加载优化有两种方式，如下图。</p> <p><img src="/Web-Performance-Optimization/assets/img/2020-10-09-02-27-44-img-load.dbdb0418.png" alt=""></p> <p>项目中常见是使用懒加载的模式，具体思路：
将非首屏的图片的 src 属性设置一个默认值，监听事件 scroll、resize、orientationchange 等事件，判断元素进入视口 viewport 时则把真实地址赋予到 src 上。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>lazy<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[占位图]<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[真实url地址]<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[不同屏幕密度下，不同的url地址]<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>I'm an image!<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>如上，data-<em>属于自定义属性， ele.dataset.</em> 可以读取自定义属性集合
img.srcset 属性用于设置不同屏幕密度下，image 自动加载不同的图片，比如<code>&lt;img src=&quot;image-128.png&quot; srcset=&quot;image-256.png 2x&quot; /&gt;</code></p> <p>这里有个简单的 <a href="http://hilongjw.github.io/vue-lazyload/" target="_blank" rel="noopener noreferrer">demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="/Web-Performance-Optimization/reference/#网络">Web 性能优化资源合集（持续更新）</a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Jecyu/Web-Performance-Optimization/edit/master/docs/network/download.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/7/2020, 11:31:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Web-Performance-Optimization/network/request.html" class="prev">资源请求</a></span> <span class="next"><a href="/Web-Performance-Optimization/network/render.html">资源渲染</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Web-Performance-Optimization/assets/js/app.7cae2d68.js" defer></script><script src="/Web-Performance-Optimization/assets/js/2.72369abb.js" defer></script><script src="/Web-Performance-Optimization/assets/js/6.66c2d2c9.js" defer></script>
  </body>
</html>
