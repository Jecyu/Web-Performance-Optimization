# webpack 优化

## 前言

HTTP 优化两个大的方向：
- 减少请求次数
- 减少单次请求所花费的时间

这两个优化点指向了我们日常开发中非常常见的操作——资源的压缩与合并。这是构建工具在做的事情，现今最流行的构建工具是 Webpack。

## Webpack 的性能平静瓶颈

webpack 优化的性能瓶颈
- 构建过程太花时间
- 打包的结果体积太大

## Webpack  的优化方案

- 使用 Tree Shaking
- 分割代码以按需加载
- 输出分析

### 构建过程提速策略

### 构建结果体积压缩

#### 文件结构可视化，找出导致体积过大的原因

#### 拆分资源

#### 删除冗余代码

#### 按需加载

## vueCli 的优化配置

因为 vueCli 本身是对 Webpack 做了一层封装，优化的思路跟 Webpack 一样。

## Gzip 压缩原理

说到压缩，可不只是构建工具的专利。我们日常开发中，还有一个方便的压缩操作：开启 Gzip。

具体做法非常简单，只需要在你的 request headers 添加上这么一句：

```bash
accept-encoding: gzip
```

这是跟 HTTP 压缩有关：
> HTTP 压缩是一种内置到网页服务器和网页客户端中以改进传输速度和带宽利用率的方式。在使用 HTTP 压缩的情况下，HTTP 数据从服务器发送前就已经压缩：兼容的浏览器将在下载所需的格式前宣告支持何种方法给服务器；不支持压缩方法的浏览器将下载未经压缩的数据。最常见的压缩方案包括 Gzip 和 Deflate。

HTTP 压缩就是以缩小体积为目的，对 HTTP 内容进行重新编码的过程。

Gzip 的内核就是 Deflate，目前我们压缩文件用得最多的就是 Gzip。

![](../.vuepress/public/assets/2020-06-26-22-37-25-gzip.png)

上图是 webpack 对 JS、CSS开启了 gzip 的压缩。画框中的 JS 源文件为 1.3MB，压缩后为 343 KB，压缩率达到 70% 以上。

### 该不该用 Gzip

如果你的项目不是极端的迷你超小型文件，都可以试试 Gzip。

有的同学或许存在这样的疑问：压缩 Gzip，服务端要花时间；解压 Gzip，浏览器要花时间。中间节省出来的传输时间，真的那么可观吗？

答案是肯定的。如果你手上的项目是 1k、2k 的小文件，那确实是有点高射炮打蚊子的意思。但更多的时候，我们处理的都是具备一定规模的项目文件。实践证明，这种情况下压缩和解压缩带来的传输过程中节省下的时间开销来说，可以说是微不足道的。

### Gzip 是万能的吗？

首先要承认 Gzip 是高效的，压缩后通常能帮我吗减少响应 70% 左右的大小。

但它并非万能的。Gzip 并不保证针对每一个文件的压缩都会使其变小。（图片则不行）

Gzip 压缩背后的原理，<u>是在一个文本文件中找出一些重复出现的字符串、临时替换它们，从而使整个文件变小。</u>根据这个原理，文件中代码的重复率越高，那么压缩的效率就越高，使用 Gzip 的收益也就越大。反之亦然。

### Webpack 的 Gzip 和服务端的 Gzip

一般来说，Gzip 压缩是服务器的活儿：服务器了解到我们这边有一个 Gzip 压缩的需求，它会启动自己的 CPU 去为我们完成这个任务。而压缩文件这个过程本身是需要耗费时间的，我们可以理解为<u>以服务器压缩的时间开销和 CPU 开销（以及浏览器解析压缩文件的开销）为代价，省去了一些传输过程中的时间开销。</u>

既然存在着这样的交换，那么就要求我们学会权衡。服务器的 CPU 性能不是无限的，如果存在大量的压缩需求，服务器也扛不住的的。服务器一旦因此慢下来了，用户还是要等。Webpack 中 Gzip 压缩操作的存在，事实上就是为了在构建过程中去做一部分服务器的工作，为服务器分压。

因此，这两个地方的 Gzip 压缩，谁也不能替代谁。作为开发者，我们也应该结合业务压力的实际强度情况，去做好其中的权衡。

```js
 plugins:
      process.env.NODE_ENV === "production"
        ? [
            new CompressionPlugin({
              filename: "[path].gz[query]",
              algorithm: "gzip",
              test: new RegExp(
                "\\.(" + productionGzipExtensions.join("|") + ")$"
              ),
              threshold: 10240,
              minRatio: 0.8
            }),
            // webpack 依赖库分析
            process.env.npm_config_report
              ? new BundleAnalyzerPlugin({
                  analyzerMode: "static"
                })
              : function none() {}
          ]
```

## 小结

